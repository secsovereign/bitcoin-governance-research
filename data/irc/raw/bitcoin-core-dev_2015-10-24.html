<!DOCTYPE html>
<html>
<title>
#bitcoin-core-dev
 on 2015-10-24
 â€” 
searchable irc log
</title>
<meta charset='utf-8'>
<meta content='IE=9' http-equiv='X-UA-Compatible'>
<link href='/style-light.css' id='stylesheet' rel='stylesheet'>
<link href='/favicon.png' rel='shortcut icon'>
<link href='http://chaincode.com/bitcoin-core-dev/2015-10-24' rel='canonical'>
<meta content='channel #bitcoin-core-dev IRC chat logs' name='description'>
<script src='/jquery.min.js'></script>
<script src='/jquery.ba-hashchange.min.js'></script>
<script src='/cookies.min.js'></script>
<script src='/application.js'></script>
<body>
<section id='sidebar'>
<section id='calendar'>
<pre class='clock'>17:28 UTC</pre>
<pre><a href="/bitcoin-core-dev/2015-09-24">&lt;</a><span class='header'>   October 2015   </span><a href="/bitcoin-core-dev/2015-11-24">&gt;</a>&#x000A;<span class='header'>Su Mo Tu We Th Fr Sa  </span>&#x000A;             <a class="" href="/bitcoin-core-dev/2015-10-01">1</a>  <a class="" href="/bitcoin-core-dev/2015-10-02">2</a>  <a class="" href="/bitcoin-core-dev/2015-10-03">3</a>  &#x000A; <a class="" href="/bitcoin-core-dev/2015-10-04">4</a>  <a class="" href="/bitcoin-core-dev/2015-10-05">5</a>  <a class="" href="/bitcoin-core-dev/2015-10-06">6</a>  <a class="" href="/bitcoin-core-dev/2015-10-07">7</a>  <a class="" href="/bitcoin-core-dev/2015-10-08">8</a>  <a class="" href="/bitcoin-core-dev/2015-10-09">9</a> <a class="" href="/bitcoin-core-dev/2015-10-10">10</a>  &#x000A;<a class="" href="/bitcoin-core-dev/2015-10-11">11</a> <a class="" href="/bitcoin-core-dev/2015-10-12">12</a> <a class="" href="/bitcoin-core-dev/2015-10-13">13</a> <a class="" href="/bitcoin-core-dev/2015-10-14">14</a> <a class="" href="/bitcoin-core-dev/2015-10-15">15</a> <a class="" href="/bitcoin-core-dev/2015-10-16">16</a> <a class="" href="/bitcoin-core-dev/2015-10-17">17</a>  &#x000A;<a class="" href="/bitcoin-core-dev/2015-10-18">18</a> <a class="" href="/bitcoin-core-dev/2015-10-19">19</a> <a class="" href="/bitcoin-core-dev/2015-10-20">20</a> <a class="" href="/bitcoin-core-dev/2015-10-21">21</a> <a class="" href="/bitcoin-core-dev/2015-10-22">22</a> <a class="" href="/bitcoin-core-dev/2015-10-23">23</a> <a class="current" href="/bitcoin-core-dev/2015-10-24">24</a>  &#x000A;<a class="" href="/bitcoin-core-dev/2015-10-25">25</a> <a class="" href="/bitcoin-core-dev/2015-10-26">26</a> <a class="" href="/bitcoin-core-dev/2015-10-27">27</a> <a class="" href="/bitcoin-core-dev/2015-10-28">28</a> <a class="" href="/bitcoin-core-dev/2015-10-29">29</a> <a class="" href="/bitcoin-core-dev/2015-10-30">30</a> <a class="" href="/bitcoin-core-dev/2015-10-31">31</a></pre>
</section>
<section id='options'>
<form action='/bitcoin-core-dev/search'>
<input id='search-box' name='q' placeholder='Enter keywords'>
<input type='submit' value='Search'>
<br/>
<br/>
<p>This is a searchable archive of <a href=/bitcoin-core-dev>#bitcoin-core-dev</a> irc</p>
<br/>
<small>
<b>Examples</b>
<br/>
<a href="http://bitcoin-irc.chaincode.com/bitcoin-core-dev/search?q=bitcoin">bitcoin</a>
<a href="http://bitcoin-irc.chaincode.com/bitcoin-core-dev/search?q=*BIP*">*BIP*</a><br/>
<a href="http://bitcoin-irc.chaincode.com/bitcoin-core-dev/search?q=%22bitcoin-git%22">bitcoin-git</a><br/>
<a href="http://bitcoin-irc.chaincode.com/bitcoin-core-dev/search?q=%22core-meetingbot%22">core-meetingbot</a>
<br/>
<br/>
</small>
<small>Search supports standard MySQL <a href="https://dev.mysql.com/doc/refman/8.0/en/fulltext-boolean.html">fulltext search operations</a></small>
<br/>
<br/>
<small>Click on the timestamp of a message for a sharable link</small>
<br/>
<br/>
<small>Message timestamps are in UTC</small>
<br/>
<br/>
<small>This archive is hosted by <a href="http://chaincode.com">Chaincode</a> and runs on <a href="https://github.com/whitequark/irclogger">irclogger</a></small>
<br/>
</form>
</section>
</section>
<section class='without-noise' data-channel='#bitcoin-core-dev' id='log'>
<aside id='log-panel'>
<a href='#' id='light_dark'></a>
<label for='filter'>
Filter:
</label>
<input id='filter'>
<span class='clear-input' id='clear_filter' style='display:none'></span>
<div class='input-group'>
<input id='show_noise' type='checkbox'>
<label for='show_noise'>
Show join/leave messages
</label>
</div>
</aside>
<div class='log-messages with-panel'>
<div class='talk op-msg' data-timestamp='1445646960' id='431830'>
<a class='timestamp' href='#431830'><time timestamp='2015-10-24T00:36:00Z'>00:36</time></a>
&lt;<span class='nick nick-4'> phantomcircuit</span>&gt;
gmaxwell, <b>*substantial*</b>
<br>
</div>

<div class='talk op-msg' data-timestamp='1445650440' id='431831'>
<a class='timestamp' href='#431831'><time timestamp='2015-10-24T01:34:00Z'>01:34</time></a>
&lt;<span class='nick nick-4'> phantomcircuit</span>&gt;
uh
<br>
</div>

<div class='talk op-msg' data-timestamp='1445650440' id='431832'>
<a class='timestamp' href='#431832'><time timestamp='2015-10-24T01:34:00Z'>01:34</time></a>
&lt;<span class='nick nick-4'> phantomcircuit</span>&gt;
yeah we definitely have some kind of memory issue in getblocktemplate
<br>
</div>

<div class='talk op-msg' data-timestamp='1445650440' id='431833'>
<a class='timestamp' href='#431833'><time timestamp='2015-10-24T01:34:00Z'>01:34</time></a>
&lt;<span class='nick nick-4'> phantomcircuit</span>&gt;
it&#x27;s trivial to recreate
<br>
</div>

<div class='talk op-msg' data-timestamp='1445650440' id='431834'>
<a class='timestamp' href='#431834'><time timestamp='2015-10-24T01:34:00Z'>01:34</time></a>
&lt;<span class='nick nick-4'> phantomcircuit</span>&gt;
while true;do bitcoin-cli getblocktemplate &gt; /dev/null;done
<br>
</div>

<div class='talk op-msg' data-timestamp='1445650440' id='431835'>
<a class='timestamp' href='#431835'><time timestamp='2015-10-24T01:34:00Z'>01:34</time></a>
&lt;<span class='nick nick-4'> phantomcircuit</span>&gt;
is enough
<br>
</div>

<div class='talk op-msg' data-timestamp='1445650920' id='431836'>
<a class='timestamp' href='#431836'><time timestamp='2015-10-24T01:42:00Z'>01:42</time></a>
&lt;<span class='nick nick-4'> phantomcircuit</span>&gt;
actually no this is expected
<br>
</div>

<div class='talk op-msg' data-timestamp='1445650980' id='431837'>
<a class='timestamp' href='#431837'><time timestamp='2015-10-24T01:43:00Z'>01:43</time></a>
&lt;<span class='nick nick-4'> phantomcircuit</span>&gt;
4GB dbcache + 1.3GB mempool + 800 MB of ?
<br>
</div>

<div class='talk op-msg' data-timestamp='1445651340' id='431838'>
<a class='timestamp' href='#431838'><time timestamp='2015-10-24T01:49:00Z'>01:49</time></a>
&lt;<span class='nick nick-4'> phantomcircuit</span>&gt;
BlueMatt, you have code to walk the cache for stuff nothing depends on?
<br>
</div>

<div class='talk op-msg' data-timestamp='1445651460' id='431839'>
<a class='timestamp' href='#431839'><time timestamp='2015-10-24T01:51:00Z'>01:51</time></a>
&lt;<span class='nick nick-4'> BlueMatt</span>&gt;
nope
<br>
</div>

<div class='talk op-msg' data-timestamp='1445651460' id='431840'>
<a class='timestamp' href='#431840'><time timestamp='2015-10-24T01:51:00Z'>01:51</time></a>
&lt;<span class='nick nick-4'> BlueMatt</span>&gt;
its not hard, though
<br>
</div>

<div class='talk op-msg' data-timestamp='1445652060' id='431841'>
<a class='timestamp' href='#431841'><time timestamp='2015-10-24T02:01:00Z'>02:01</time></a>
&lt;<span class='nick nick-13'> sipa</span>&gt;
there is no &quot;depends&quot;
<br>
</div>

<div class='talk op-msg' data-timestamp='1445652060' id='431842'>
<a class='timestamp' href='#431842'><time timestamp='2015-10-24T02:01:00Z'>02:01</time></a>
&lt;<span class='nick nick-13'> sipa</span>&gt;
it&#x27;s a cache
<br>
</div>

<div class='talk op-msg' data-timestamp='1445652060' id='431843'>
<a class='timestamp' href='#431843'><time timestamp='2015-10-24T02:01:00Z'>02:01</time></a>
&lt;<span class='nick nick-4'> BlueMatt</span>&gt;
sipa: you know what he meant
<br>
</div>

<div class='talk op-msg' data-timestamp='1445652240' id='431844'>
<a class='timestamp' href='#431844'><time timestamp='2015-10-24T02:04:00Z'>02:04</time></a>
&lt;<span class='nick nick-13'> sipa</span>&gt;
it&#x27;s expected tgat gbt increases the cache size, as it will pull in all dependencies
<br>
</div>

<div class='talk op-msg' data-timestamp='1445652240' id='431845'>
<a class='timestamp' href='#431845'><time timestamp='2015-10-24T02:04:00Z'>02:04</time></a>
&lt;<span class='nick nick-4'> BlueMatt</span>&gt;
sipa: indeed, not sure what phantomcircuit is seeing is unexpected or not, but the graphs in the ml related to <a href="https://github.com/bitcoin/bitcoin/issues/6876" class="link" target="_blank">https://github.com/bitcoin/bitcoin/issues/6876</a> are not expected at all
<br>
</div>

<div class='talk op-msg' data-timestamp='1445652360' id='431846'>
<a class='timestamp' href='#431846'><time timestamp='2015-10-24T02:06:00Z'>02:06</time></a>
&lt;<span class='nick nick-13'> sipa</span>&gt;
well i have no idea what the gbt code is all doing
<br>
</div>

<div class='talk op-msg' data-timestamp='1445652840' id='431847'>
<a class='timestamp' href='#431847'><time timestamp='2015-10-24T02:14:00Z'>02:14</time></a>
&lt;<span class='nick nick-4'> phantomcircuit</span>&gt;
BlueMatt, what im seeing is 6.3GB of ram being used with dbcache=4096
<br>
</div>

<div class='talk op-msg' data-timestamp='1445652900' id='431848'>
<a class='timestamp' href='#431848'><time timestamp='2015-10-24T02:15:00Z'>02:15</time></a>
&lt;<span class='nick nick-4'> BlueMatt</span>&gt;
phantomcircuit: in dbcache? that sounds about right
<br>
</div>

<div class='talk op-msg' data-timestamp='1445652900' id='431849'>
<a class='timestamp' href='#431849'><time timestamp='2015-10-24T02:15:00Z'>02:15</time></a>
&lt;<span class='nick nick-4'> phantomcircuit</span>&gt;
and calling gettxoutsetinfo (which calls FlushStateToDisk) not changing that
<br>
</div>

<div class='talk op-msg' data-timestamp='1445652900' id='431850'>
<a class='timestamp' href='#431850'><time timestamp='2015-10-24T02:15:00Z'>02:15</time></a>
&lt;<span class='nick nick-4'> BlueMatt</span>&gt;
oh
<br>
</div>

<div class='talk op-msg' data-timestamp='1445652900' id='431851'>
<a class='timestamp' href='#431851'><time timestamp='2015-10-24T02:15:00Z'>02:15</time></a>
&lt;<span class='nick nick-4'> BlueMatt</span>&gt;
hmm
<br>
</div>

<div class='talk op-msg' data-timestamp='1445653200' id='431852'>
<a class='timestamp' href='#431852'><time timestamp='2015-10-24T02:20:00Z'>02:20</time></a>
&lt;<span class='nick nick-13'> sipa</span>&gt;
GBT copies a significant portion of the cache into its own view
<br>
</div>

<div class='talk op-msg' data-timestamp='1445653200' id='431853'>
<a class='timestamp' href='#431853'><time timestamp='2015-10-24T02:20:00Z'>02:20</time></a>
&lt;<span class='nick nick-13'> sipa</span>&gt;
so it can pretty much double the memory usage
<br>
</div>

<div class='talk op-msg' data-timestamp='1445653320' id='431854'>
<a class='timestamp' href='#431854'><time timestamp='2015-10-24T02:22:00Z'>02:22</time></a>
&lt;<span class='nick nick-4'> phantomcircuit</span>&gt;
sipa, yeah but that view is destroyed at the end of the CreateNewBlock call
<br>
</div>

<div class='talk op-msg' data-timestamp='1445653320' id='431855'>
<a class='timestamp' href='#431855'><time timestamp='2015-10-24T02:22:00Z'>02:22</time></a>
&lt;<span class='nick nick-13'> sipa</span>&gt;
does change your res
<br>
</div>

<div class='talk op-msg' data-timestamp='1445653320' id='431856'>
<a class='timestamp' href='#431856'><time timestamp='2015-10-24T02:22:00Z'>02:22</time></a>
&lt;<span class='nick nick-13'> sipa</span>&gt;
*doesn&#x27;t
<br>
</div>

<div class='talk op-msg' data-timestamp='1445653320' id='431857'>
<a class='timestamp' href='#431857'><time timestamp='2015-10-24T02:22:00Z'>02:22</time></a>
&lt;<span class='nick nick-4'> phantomcircuit</span>&gt;
right because of memory allocation stuff
<br>
</div>

<div class='talk op-msg' data-timestamp='1445653380' id='431858'>
<a class='timestamp' href='#431858'><time timestamp='2015-10-24T02:23:00Z'>02:23</time></a>
&lt;<span class='nick nick-13'> sipa</span>&gt;
fragmentation etc
<br>
</div>

<div class='talk op-msg' data-timestamp='1445653620' id='431859'>
<a class='timestamp' href='#431859'><time timestamp='2015-10-24T02:27:00Z'>02:27</time></a>
&lt;<span class='nick nick-4'> phantomcircuit</span>&gt;
sipa, hmm boost::unordered_map is buckets so make expanding easier
<br>
</div>

<div class='talk op-msg' data-timestamp='1445654100' id='431860'>
<a class='timestamp' href='#431860'><time timestamp='2015-10-24T02:35:00Z'>02:35</time></a>
&lt;<span class='nick nick-4'> phantomcircuit</span>&gt;
im not sure that&#x27;s it though since memory usage just jumped 700MB more
<br>
</div>

<div class='talk op-msg' data-timestamp='1445654100' id='431861'>
<a class='timestamp' href='#431861'><time timestamp='2015-10-24T02:35:00Z'>02:35</time></a>
&lt;<span class='nick nick-4'> phantomcircuit</span>&gt;
i cant imagine that&#x27;s from fragmentation alone
<br>
</div>

<div class='talk op-msg' data-timestamp='1445654160' id='431862'>
<a class='timestamp' href='#431862'><time timestamp='2015-10-24T02:36:00Z'>02:36</time></a>
&lt;<span class='nick nick-13'> sipa</span>&gt;
well if there is 800 MB chaonstatr depended on by the mempool, then GBT will add another 800 MB
<br>
</div>

<div class='talk op-msg' data-timestamp='1445654220' id='431863'>
<a class='timestamp' href='#431863'><time timestamp='2015-10-24T02:37:00Z'>02:37</time></a>
&lt;<span class='nick nick-13'> sipa</span>&gt;
fragmentation just makes it not able to release it back
<br>
</div>

<div class='talk op-msg' data-timestamp='1445654220' id='431864'>
<a class='timestamp' href='#431864'><time timestamp='2015-10-24T02:37:00Z'>02:37</time></a>
&lt;<span class='nick nick-4'> phantomcircuit</span>&gt;
chainstate?
<br>
</div>

<div class='talk op-msg' data-timestamp='1445654280' id='431865'>
<a class='timestamp' href='#431865'><time timestamp='2015-10-24T02:38:00Z'>02:38</time></a>
&lt;<span class='nick nick-13'> sipa</span>&gt;
yes
<br>
</div>

<div class='talk op-msg' data-timestamp='1445654280' id='431866'>
<a class='timestamp' href='#431866'><time timestamp='2015-10-24T02:38:00Z'>02:38</time></a>
&lt;<span class='nick nick-13'> sipa</span>&gt;
typing in a driving car on a small keyboard
<br>
</div>

<div class='talk op-msg' data-timestamp='1445654520' id='431867'>
<a class='timestamp' href='#431867'><time timestamp='2015-10-24T02:42:00Z'>02:42</time></a>
&lt;<span class='nick nick-4'> phantomcircuit</span>&gt;
oh duh right they&#x27;re separate
<br>
</div>

<div class='talk op-msg' data-timestamp='1445657580' id='431868'>
<a class='timestamp' href='#431868'><time timestamp='2015-10-24T03:33:00Z'>03:33</time></a>
&lt;<span class='nick nick-11'> morcos</span>&gt;
the problem with GBT is it can create that much memory usage per each of the RPC threads
<br>
</div>

<div class='talk op-msg' data-timestamp='1445657640' id='431869'>
<a class='timestamp' href='#431869'><time timestamp='2015-10-24T03:34:00Z'>03:34</time></a>
&lt;<span class='nick nick-11'> morcos</span>&gt;
each thread allocates the memory in a separate arena, and even though the objects are destroyed at the end of the call, there tends to be enough fragmentation that the memory isn&#x27;t entirely free
<br>
</div>

<div class='talk op-msg' data-timestamp='1445657760' id='431870'>
<a class='timestamp' href='#431870'><time timestamp='2015-10-24T03:36:00Z'>03:36</time></a>
&lt;<span class='nick nick-11'> morcos</span>&gt;
in addition, if your chainstate expands during an RPC call (such as due to GBT) enough to cause a rehash of the unordered map
<br>
</div>

<div class='talk op-msg' data-timestamp='1445657760' id='431871'>
<a class='timestamp' href='#431871'><time timestamp='2015-10-24T03:36:00Z'>03:36</time></a>
&lt;<span class='nick nick-11'> morcos</span>&gt;
then this also will be allocated in a new arena, and possibly all the old chainstate won&#x27;t be cleaned up
<br>
</div>

<div class='talk op-msg' data-timestamp='1445657880' id='431872'>
<a class='timestamp' href='#431872'><time timestamp='2015-10-24T03:38:00Z'>03:38</time></a>
&lt;<span class='nick nick-11'> morcos</span>&gt;
phantomcircuit: sipa: ^  not sure if you followed the earlier conversation i had with wumpus and gmaxwell about this
<br>
</div>

<div class='talk op-msg' data-timestamp='1445666460' id='431873'>
<a class='timestamp' href='#431873'><time timestamp='2015-10-24T06:01:00Z'>06:01</time></a>
&lt;<span class='nick nick-13'> cfields</span>&gt;
gmaxwell: for backlog, i added in Tor&#x27;s RESOLVE extension to SOCKS5 so that we can query all seeds up front without making actual node connections. Not sure if there&#x27;s any real benefit, but it was trivial to add.
<br>
</div>

<div class='talk op-msg' data-timestamp='1445666640' id='431874'>
<a class='timestamp' href='#431874'><time timestamp='2015-10-24T06:04:00Z'>06:04</time></a>
&lt;<span class='nick nick-16'> wumpus</span>&gt;
cfields: nice
<br>
</div>

<div class='talk op-msg' data-timestamp='1445673480' id='431875'>
<a class='timestamp' href='#431875'><time timestamp='2015-10-24T07:58:00Z'>07:58</time></a>
&lt;<span class='nick nick-5'> jgarzik</span>&gt;
jcorgan, btcdrak: 2015_sqlite branch now works, passes tests
<br>
</div>

<div class='talk op-msg' data-timestamp='1445673480' id='431876'>
<a class='timestamp' href='#431876'><time timestamp='2015-10-24T07:58:00Z'>07:58</time></a>
&lt;<span class='nick nick-5'> jgarzik</span>&gt;
not yet performance-tuned
<br>
</div>

<div class='talk op-msg' data-timestamp='1445673600' id='431877'>
<a class='timestamp' href='#431877'><time timestamp='2015-10-24T08:00:00Z'>08:00</time></a>
&lt;<span class='nick nick-16'> wumpus</span>&gt;
great
<br>
</div>

<div class='talk op-msg' data-timestamp='1445673600' id='431878'>
<a class='timestamp' href='#431878'><time timestamp='2015-10-24T08:00:00Z'>08:00</time></a>
&lt;<span class='nick nick-3'> * wumpus</span>&gt;
switches to sqlite
<br>
</div>

<div class='talk op-msg' data-timestamp='1445673960' id='431879'>
<a class='timestamp' href='#431879'><time timestamp='2015-10-24T08:06:00Z'>08:06</time></a>
&lt;<span class='nick nick-5'> jgarzik</span>&gt;
no apparent transaction size limit.  &quot;I am able to insert 10 million rows in a single transaction&quot;
<br>
</div>

<div class='talk op-msg' data-timestamp='1445674020' id='431880'>
<a class='timestamp' href='#431880'><time timestamp='2015-10-24T08:07:00Z'>08:07</time></a>
&lt;<span class='nick nick-5'> jgarzik</span>&gt;
BEGIN...COMMIT maps easily to DBWrapper&#x27;s batches
<br>
</div>

<div class='talk op-msg' data-timestamp='1445674860' id='431881'>
<a class='timestamp' href='#431881'><time timestamp='2015-10-24T08:21:00Z'>08:21</time></a>
&lt;<span class='nick nick-16'> wumpus</span>&gt;
that&#x27;s good news
<br>
</div>

<div class='talk op-msg' data-timestamp='1445674920' id='431882'>
<a class='timestamp' href='#431882'><time timestamp='2015-10-24T08:22:00Z'>08:22</time></a>
&lt;<span class='nick nick-16'> wumpus</span>&gt;
one question: will using the mysql branch blow my old leveldb database, or can they exist side by side?
<br>
</div>

<div class='talk op-msg' data-timestamp='1445674980' id='431883'>
<a class='timestamp' href='#431883'><time timestamp='2015-10-24T08:23:00Z'>08:23</time></a>
&lt;<span class='nick nick-16'> wumpus</span>&gt;
will just create a new datadir to be sure
<br>
</div>

<div class='talk op-msg' data-timestamp='1445675100' id='431884'>
<a class='timestamp' href='#431884'><time timestamp='2015-10-24T08:25:00Z'>08:25</time></a>
&lt;<span class='nick nick-5'> jgarzik</span>&gt;
should be able to exist side by side
<br>
</div>

<div class='talk op-msg' data-timestamp='1445675100' id='431885'>
<a class='timestamp' href='#431885'><time timestamp='2015-10-24T08:25:00Z'>08:25</time></a>
&lt;<span class='nick nick-5'> jgarzik</span>&gt;
sqlite database is a file named &quot;db&quot;
<br>
</div>

<div class='talk op-msg' data-timestamp='1445675160' id='431886'>
<a class='timestamp' href='#431886'><time timestamp='2015-10-24T08:26:00Z'>08:26</time></a>
&lt;<span class='nick nick-5'> jgarzik</span>&gt;
but don&#x27;t trust me - be certain and create a new datadir :)
<br>
</div>

<div class='talk op-msg' data-timestamp='1445675220' id='431887'>
<a class='timestamp' href='#431887'><time timestamp='2015-10-24T08:27:00Z'>08:27</time></a>
&lt;<span class='nick nick-5'> jgarzik</span>&gt;
1) Here are all the tweaks for an sqlite database: <a href="https://www.sqlite.org/pragma.html" class="link" target="_blank">https://www.sqlite.org/pragma.html</a>
<br>
</div>

<div class='talk op-msg' data-timestamp='1445675280' id='431888'>
<a class='timestamp' href='#431888'><time timestamp='2015-10-24T08:28:00Z'>08:28</time></a>
&lt;<span class='nick nick-5'> jgarzik</span>&gt;
2) git pull the latest 2015_sqlite branch, it includes some key performance tweaks in dbwrapper.cpp (grep for PRAGMA)
<br>
</div>

<div class='talk op-msg' data-timestamp='1445675280' id='431889'>
<a class='timestamp' href='#431889'><time timestamp='2015-10-24T08:28:00Z'>08:28</time></a>
&lt;<span class='nick nick-7'> * jgarzik</span>&gt;
heads back to bed <b>*poof*</b>
<br>
</div>

<div class='talk op-msg' data-timestamp='1445675400' id='431890'>
<a class='timestamp' href='#431890'><time timestamp='2015-10-24T08:30:00Z'>08:30</time></a>
&lt;<span class='nick nick-6'> btcdrak</span>&gt;
jgarzik: I&#x27;ll take a look
<br>
</div>

<div class='talk op-msg' data-timestamp='1445675400' id='431891'>
<a class='timestamp' href='#431891'><time timestamp='2015-10-24T08:30:00Z'>08:30</time></a>
&lt;<span class='nick nick-7'> GitHub65</span>&gt;
[bitcoin] giacecco opened pull request #6885: Instructions on how to make the Homebrew OpenSSL headers visible... (master...master) <a href="https://github.com/bitcoin/bitcoin/pull/6885" class="link" target="_blank">https://github.com/bitcoin/bitcoin/pull/6885</a>
<br>
</div>

<div class='talk op-msg' data-timestamp='1445690820' id='431892'>
<a class='timestamp' href='#431892'><time timestamp='2015-10-24T12:47:00Z'>12:47</time></a>
&lt;<span class='nick nick-16'> wumpus</span>&gt;
2015-10-24 12:45:29 UpdateTip: new best=000000000000000bf325356179fb8876fe40e250c9e31082242f70f89ecbcd0b height=240923 log2_work=70.308629 tx=1
<br>
</div>

<div class='talk op-msg' data-timestamp='1445690820' id='431893'>
<a class='timestamp' href='#431893'><time timestamp='2015-10-24T12:47:00Z'>12:47</time></a>
&lt;<span class='nick nick-16'> wumpus</span>&gt;
9292749 date=2013-06-11 12:51:49 progress=0.093959 cache=65.5MiB(34687tx)
<br>
</div>

<div class='talk op-msg' data-timestamp='1445690820' id='431894'>
<a class='timestamp' href='#431894'><time timestamp='2015-10-24T12:47:00Z'>12:47</time></a>
&lt;<span class='nick nick-16'> wumpus</span>&gt;
2015-10-24 12:46:10 UpdateTip: new best=00000000000000ecca86ba925835b0909eeba33fd90ae9858c01e088d4d13bcf height=240924 log2_work=70.308695 tx=1
<br>
</div>

<div class='talk op-msg' data-timestamp='1445690820' id='431895'>
<a class='timestamp' href='#431895'><time timestamp='2015-10-24T12:47:00Z'>12:47</time></a>
&lt;<span class='nick nick-16'> wumpus</span>&gt;
9293107 date=2013-06-11 12:59:51 progress=0.093961 cache=2.0MiB(0tx)
<br>
</div>

<div class='talk op-msg' data-timestamp='1445690880' id='431896'>
<a class='timestamp' href='#431896'><time timestamp='2015-10-24T12:48:00Z'>12:48</time></a>
&lt;<span class='nick nick-16'> wumpus</span>&gt;
it seems like the flushing takes quite a long time with sqlite (40 seconds in this case), haven&#x27;t done a direct comparison with leveldb though
<br>
</div>

<div class='talk op-msg' data-timestamp='1445690880' id='431897'>
<a class='timestamp' href='#431897'><time timestamp='2015-10-24T12:48:00Z'>12:48</time></a>
&lt;<span class='nick nick-16'> wumpus</span>&gt;
but it blazes past N blocks, then hangs noticably on the flush, longer than I remember
<br>
</div>

<div class='talk op-msg' data-timestamp='1445691840' id='431898'>
<a class='timestamp' href='#431898'><time timestamp='2015-10-24T13:04:00Z'>13:04</time></a>
&lt;<span class='nick nick-16'> wumpus</span>&gt;
at first glance it seems to do a lot of calls to fsync()
<br>
</div>

<div class='talk op-msg' data-timestamp='1445691840' id='431899'>
<a class='timestamp' href='#431899'><time timestamp='2015-10-24T13:04:00Z'>13:04</time></a>
&lt;<span class='nick nick-16'> wumpus</span>&gt;
(unscientifically tested by running in gdb and breaking+backtracing a few times)
<br>
</div>

<div class='talk op-msg' data-timestamp='1445694060' id='431900'>
<a class='timestamp' href='#431900'><time timestamp='2015-10-24T13:41:00Z'>13:41</time></a>
&lt;<span class='nick nick-16'> wumpus</span>&gt;
yes it&#x27;s fsyncing - removing the fsync calls (obviously a stupid idea in itself) flush time is down to &lt;10 seconds. I understand calling fsync, but is it doing so for every single statement?
<br>
</div>

<div class='talk op-msg' data-timestamp='1445696100' id='431901'>
<a class='timestamp' href='#431901'><time timestamp='2015-10-24T14:15:00Z'>14:15</time></a>
&lt;<span class='nick nick-8'> jcorgan</span>&gt;
wumpus: confirming same behavior here
<br>
</div>

<div class='talk op-msg' data-timestamp='1445696340' id='431902'>
<a class='timestamp' href='#431902'><time timestamp='2015-10-24T14:19:00Z'>14:19</time></a>
&lt;<span class='nick nick-16'> wumpus</span>&gt;
&quot;PRAGMA synchronous=0&quot; works too (make sure it&#x27;s executed every time the database is opened) instead of commenting out fsyncs - though won&#x27;t be very resistant to crashes <a href="https://www.sqlite.org/pragma.html#pragma_synchronous" class="link" target="_blank">https://www.sqlite.org/pragma.html#pragma_synchronous</a>
<br>
</div>

<div class='talk op-msg' data-timestamp='1445696400' id='431903'>
<a class='timestamp' href='#431903'><time timestamp='2015-10-24T14:20:00Z'>14:20</time></a>
&lt;<span class='nick nick-8'> jcorgan</span>&gt;
heh, isn&#x27;t the whole reason we&#x27;re testing this is to improve crash resistance? :-)
<br>
</div>

<div class='talk op-msg' data-timestamp='1445696460' id='431904'>
<a class='timestamp' href='#431904'><time timestamp='2015-10-24T14:21:00Z'>14:21</time></a>
&lt;<span class='nick nick-16'> wumpus</span>&gt;
yeah...
<br>
</div>

<div class='talk op-msg' data-timestamp='1445696520' id='431905'>
<a class='timestamp' href='#431905'><time timestamp='2015-10-24T14:22:00Z'>14:22</time></a>
&lt;<span class='nick nick-8'> jcorgan</span>&gt;
once this reindexes i&#x27;ll bet steady-state performance won&#x27;t really be any different
<br>
</div>

<div class='talk op-msg' data-timestamp='1445696520' id='431906'>
<a class='timestamp' href='#431906'><time timestamp='2015-10-24T14:22:00Z'>14:22</time></a>
&lt;<span class='nick nick-16'> wumpus</span>&gt;
so sqlite&#x27;s idea of crash resistance seems to be &#x27;fsync after every file operation&#x27;. Or maybe it&#x27;s after some buffer fills that can be increased, I don&#x27;t know.
<br>
</div>

<div class='talk op-msg' data-timestamp='1445696520' id='431907'>
<a class='timestamp' href='#431907'><time timestamp='2015-10-24T14:22:00Z'>14:22</time></a>
&lt;<span class='nick nick-16'> wumpus</span>&gt;
jcorgan: I&#x27;ll bet the same
<br>
</div>

<div class='talk op-msg' data-timestamp='1445696580' id='431908'>
<a class='timestamp' href='#431908'><time timestamp='2015-10-24T14:23:00Z'>14:23</time></a>
&lt;<span class='nick nick-8'> jcorgan</span>&gt;
hmm, reindexing is actually speeding up as it goes along
<br>
</div>

<div class='talk op-msg' data-timestamp='1445696700' id='431909'>
<a class='timestamp' href='#431909'><time timestamp='2015-10-24T14:25:00Z'>14:25</time></a>
&lt;<span class='nick nick-8'> jcorgan</span>&gt;
eyeballing it it is about 150-200 blocks/sec, with peak disk writes of about 70-80 MB/sec
<br>
</div>

<div class='talk op-msg' data-timestamp='1445696760' id='431910'>
<a class='timestamp' href='#431910'><time timestamp='2015-10-24T14:26:00Z'>14:26</time></a>
&lt;<span class='nick nick-16'> wumpus</span>&gt;
jgarzik: the pragma tweaks in sql_db_init are not persistent - they need to be done every time the db opens, not only when it is created
<br>
</div>

<div class='talk op-msg' data-timestamp='1445697060' id='431911'>
<a class='timestamp' href='#431911'><time timestamp='2015-10-24T14:31:00Z'>14:31</time></a>
&lt;<span class='nick nick-5'> jgarzik</span>&gt;
wumpus, very odd - I would think page size is persistent
<br>
</div>

<div class='talk op-msg' data-timestamp='1445697120' id='431912'>
<a class='timestamp' href='#431912'><time timestamp='2015-10-24T14:32:00Z'>14:32</time></a>
&lt;<span class='nick nick-16'> wumpus</span>&gt;
this sounds interesting: <a href="https://www.sqlite.org/wal.html" class="link" target="_blank">https://www.sqlite.org/wal.html</a>
<br>
</div>

<div class='talk op-msg' data-timestamp='1445697120' id='431913'>
<a class='timestamp' href='#431913'><time timestamp='2015-10-24T14:32:00Z'>14:32</time></a>
&lt;<span class='nick nick-5'> jgarzik</span>&gt;
nod
<br>
</div>

<div class='talk op-msg' data-timestamp='1445697120' id='431914'>
<a class='timestamp' href='#431914'><time timestamp='2015-10-24T14:32:00Z'>14:32</time></a>
&lt;<span class='nick nick-5'> jgarzik</span>&gt;
Plenty of tips (sounds like you already figured out some) in <a href="https://www.sqlite.org/cvstrac/wiki?p=PerformanceTuning" class="link" target="_blank">https://www.sqlite.org/cvstrac/wiki?p=PerformanceTuning</a>
<br>
</div>

<div class='talk op-msg' data-timestamp='1445697180' id='431915'>
<a class='timestamp' href='#431915'><time timestamp='2015-10-24T14:33:00Z'>14:33</time></a>
&lt;<span class='nick nick-5'> jgarzik</span>&gt;
you can play around with logging types
<br>
</div>

<div class='talk op-msg' data-timestamp='1445697180' id='431916'>
<a class='timestamp' href='#431916'><time timestamp='2015-10-24T14:33:00Z'>14:33</time></a>
&lt;<span class='nick nick-16'> wumpus</span>&gt;
jgarzik: probably the database is created with one page size, but e.g. cache size isn&#x27;t remembered
<br>
</div>

<div class='talk op-msg' data-timestamp='1445697420' id='431917'>
<a class='timestamp' href='#431917'><time timestamp='2015-10-24T14:37:00Z'>14:37</time></a>
&lt;<span class='nick nick-16'> wumpus</span>&gt;
good news, PRAGMA journal_mode=WAL; seems to solve the excessive-fsync problem too
<br>
</div>

<div class='talk op-msg' data-timestamp='1445697540' id='431918'>
<a class='timestamp' href='#431918'><time timestamp='2015-10-24T14:39:00Z'>14:39</time></a>
&lt;<span class='nick nick-16'> wumpus</span>&gt;
&quot;WAL works best with smaller transactions. WAL does not work well for very large transactions. For transactions larger than about 100 megabytes, traditional rollback journal modes will likely be faster&quot;  that&#x27;s strange - we certainly have transactions that big
<br>
</div>

<div class='talk op-msg' data-timestamp='1445697540' id='431919'>
<a class='timestamp' href='#431919'><time timestamp='2015-10-24T14:39:00Z'>14:39</time></a>
&lt;<span class='nick nick-5'> jgarzik</span>&gt;
In C++, is there a one-line way to convert an int to a std::string ?
<br>
</div>

<div class='talk op-msg' data-timestamp='1445697540' id='431920'>
<a class='timestamp' href='#431920'><time timestamp='2015-10-24T14:39:00Z'>14:39</time></a>
&lt;<span class='nick nick-5'> jgarzik</span>&gt;
i.e. &quot;foo&quot; + numstr(22)
<br>
</div>

<div class='talk op-msg' data-timestamp='1445697540' id='431921'>
<a class='timestamp' href='#431921'><time timestamp='2015-10-24T14:39:00Z'>14:39</time></a>
&lt;<span class='nick nick-16'> wumpus</span>&gt;
we have itostr in utilstrencodings.h
<br>
</div>

<div class='talk op-msg' data-timestamp='1445697600' id='431922'>
<a class='timestamp' href='#431922'><time timestamp='2015-10-24T14:40:00Z'>14:40</time></a>
&lt;<span class='nick nick-16'> wumpus</span>&gt;
and i64tostr
<br>
</div>

<div class='talk op-msg' data-timestamp='1445697600' id='431923'>
<a class='timestamp' href='#431923'><time timestamp='2015-10-24T14:40:00Z'>14:40</time></a>
&lt;<span class='nick nick-5'> jgarzik</span>&gt;
ok, perfect
<br>
</div>

<div class='talk op-msg' data-timestamp='1445697840' id='431924'>
<a class='timestamp' href='#431924'><time timestamp='2015-10-24T14:44:00Z'>14:44</time></a>
&lt;<span class='nick nick-5'> jgarzik</span>&gt;
wumpus, pushed the db init fix to 2015_sqlite (where params like cache_size are configured every time, but &#x27;create table&#x27; happens only once)
<br>
</div>

<div class='talk op-msg' data-timestamp='1445697900' id='431925'>
<a class='timestamp' href='#431925'><time timestamp='2015-10-24T14:45:00Z'>14:45</time></a>
&lt;<span class='nick nick-5'> jgarzik</span>&gt;
wumpus, WAL should be good for us
<br>
</div>

<div class='talk op-msg' data-timestamp='1445697900' id='431926'>
<a class='timestamp' href='#431926'><time timestamp='2015-10-24T14:45:00Z'>14:45</time></a>
&lt;<span class='nick nick-8'> jcorgan</span>&gt;
is that in your update?
<br>
</div>

<div class='talk op-msg' data-timestamp='1445697900' id='431927'>
<a class='timestamp' href='#431927'><time timestamp='2015-10-24T14:45:00Z'>14:45</time></a>
&lt;<span class='nick nick-5'> jgarzik</span>&gt;
jcorgan, WAL? no
<br>
</div>

<div class='talk op-msg' data-timestamp='1445698020' id='431928'>
<a class='timestamp' href='#431928'><time timestamp='2015-10-24T14:47:00Z'>14:47</time></a>
&lt;<span class='nick nick-5'> jgarzik</span>&gt;
jcorgan, it&#x27;s pretty obvious where to add configuration lines at the top of dbwrapper.cpp, so it&#x27;s straightforward
<br>
</div>

<div class='talk op-msg' data-timestamp='1445698020' id='431929'>
<a class='timestamp' href='#431929'><time timestamp='2015-10-24T14:47:00Z'>14:47</time></a>
&lt;<span class='nick nick-5'> jgarzik</span>&gt;
Another todo item is making the cache size configurable
<br>
</div>

<div class='talk op-msg' data-timestamp='1445698080' id='431930'>
<a class='timestamp' href='#431930'><time timestamp='2015-10-24T14:48:00Z'>14:48</time></a>
&lt;<span class='nick nick-5'> jgarzik</span>&gt;
(via runtime GetArg, I mean)
<br>
</div>

<div class='talk op-msg' data-timestamp='1445698200' id='431931'>
<a class='timestamp' href='#431931'><time timestamp='2015-10-24T14:50:00Z'>14:50</time></a>
&lt;<span class='nick nick-5'> jgarzik</span>&gt;
70-80 MB/sec is pretty darned good
<br>
</div>

<div class='talk op-msg' data-timestamp='1445698200' id='431932'>
<a class='timestamp' href='#431932'><time timestamp='2015-10-24T14:50:00Z'>14:50</time></a>
&lt;<span class='nick nick-8'> jcorgan</span>&gt;
btrfs on hardware raid 10 :-)
<br>
</div>

<div class='talk op-msg' data-timestamp='1445698200' id='431933'>
<a class='timestamp' href='#431933'><time timestamp='2015-10-24T14:50:00Z'>14:50</time></a>
&lt;<span class='nick nick-5'> jgarzik</span>&gt;
I would be interested in the wall clock reindex time
<br>
</div>

<div class='talk op-msg' data-timestamp='1445698200' id='431934'>
<a class='timestamp' href='#431934'><time timestamp='2015-10-24T14:50:00Z'>14:50</time></a>
&lt;<span class='nick nick-5'> jgarzik</span>&gt;
of master vs sqlite
<br>
</div>

<div class='talk op-msg' data-timestamp='1445698260' id='431935'>
<a class='timestamp' href='#431935'><time timestamp='2015-10-24T14:51:00Z'>14:51</time></a>
&lt;<span class='nick nick-8'> jcorgan</span>&gt;
i&#x27;m restarting with WAL, i&#x27;ll time it
<br>
</div>

<div class='talk op-msg' data-timestamp='1445698260' id='431936'>
<a class='timestamp' href='#431936'><time timestamp='2015-10-24T14:51:00Z'>14:51</time></a>
&lt;<span class='nick nick-8'> jcorgan</span>&gt;
btrfs snapshots are the bomb
<br>
</div>

<div class='talk op-msg' data-timestamp='1445698320' id='431937'>
<a class='timestamp' href='#431937'><time timestamp='2015-10-24T14:52:00Z'>14:52</time></a>
&lt;<span class='nick nick-16'> wumpus</span>&gt;
with WAL, PRAGMA wal_autocheckpoint has a lot of influence in the number of fsyncs
<br>
</div>

<div class='talk op-msg' data-timestamp='1445698380' id='431938'>
<a class='timestamp' href='#431938'><time timestamp='2015-10-24T14:53:00Z'>14:53</time></a>
&lt;<span class='nick nick-7'> * jgarzik</span>&gt;
doesn&#x27;t see a need for fsync inside a batch
<br>
</div>

<div class='talk op-msg' data-timestamp='1445698440' id='431939'>
<a class='timestamp' href='#431939'><time timestamp='2015-10-24T14:54:00Z'>14:54</time></a>
&lt;<span class='nick nick-5'> jgarzik</span>&gt;
as long as post-crash we see a consistent picture, we can lose the WAL-in-progress
<br>
</div>

<div class='talk op-msg' data-timestamp='1445698440' id='431940'>
<a class='timestamp' href='#431940'><time timestamp='2015-10-24T14:54:00Z'>14:54</time></a>
&lt;<span class='nick nick-16'> wumpus</span>&gt;
well it <b>*looks*</b> to me that it&#x27;s this: during a batch it writes to the journal, and it fsyncs the journal. I agree though.
<br>
</div>

<div class='talk op-msg' data-timestamp='1445698440' id='431941'>
<a class='timestamp' href='#431941'><time timestamp='2015-10-24T14:54:00Z'>14:54</time></a>
&lt;<span class='nick nick-5'> jgarzik</span>&gt;
changes are batched to std::vector&lt;&gt; internally, and then flooded to the db in a rapid BEGIN..INSERT*..COMMIT sequence.
<br>
</div>

<div class='talk op-msg' data-timestamp='1445698500' id='431942'>
<a class='timestamp' href='#431942'><time timestamp='2015-10-24T14:55:00Z'>14:55</time></a>
&lt;<span class='nick nick-16'> wumpus</span>&gt;
no need to checkpoint <b>*ever*</b> during a batch
<br>
</div>

<div class='talk op-msg' data-timestamp='1445698500' id='431943'>
<a class='timestamp' href='#431943'><time timestamp='2015-10-24T14:55:00Z'>14:55</time></a>
&lt;<span class='nick nick-5'> jgarzik</span>&gt;
correct
<br>
</div>

<div class='talk op-msg' data-timestamp='1445698560' id='431944'>
<a class='timestamp' href='#431944'><time timestamp='2015-10-24T14:56:00Z'>14:56</time></a>
&lt;<span class='nick nick-13'> sipa</span>&gt;
cache size is controlled by -dbcache already
<br>
</div>

<div class='talk op-msg' data-timestamp='1445698560' id='431945'>
<a class='timestamp' href='#431945'><time timestamp='2015-10-24T14:56:00Z'>14:56</time></a>
&lt;<span class='nick nick-13'> sipa</span>&gt;
part of it is assigned to pcoinsTip cache, part to the database layer itself
<br>
</div>

<div class='talk op-msg' data-timestamp='1445698620' id='431946'>
<a class='timestamp' href='#431946'><time timestamp='2015-10-24T14:57:00Z'>14:57</time></a>
&lt;<span class='nick nick-13'> sipa</span>&gt;
using a totally arbitrary formula
<br>
</div>

<div class='talk op-msg' data-timestamp='1445698620' id='431947'>
<a class='timestamp' href='#431947'><time timestamp='2015-10-24T14:57:00Z'>14:57</time></a>
&lt;<span class='nick nick-5'> jgarzik</span>&gt;
sipa, the specific need is for sqlite to move from static constant stored within a constant &quot;foo&quot; string to GetArg configured with that
<br>
</div>

<div class='talk op-msg' data-timestamp='1445698680' id='431948'>
<a class='timestamp' href='#431948'><time timestamp='2015-10-24T14:58:00Z'>14:58</time></a>
&lt;<span class='nick nick-5'> jgarzik</span>&gt;
sipa, Line 23 of <a href="https://github.com/jgarzik/bitcoin/blob/4d2e72900de85a1e2ffbc9470df05794242b82b9/src/dbwrapper.cpp#L23" class="link" target="_blank">https://github.com/jgarzik/bitcoin/blob/4d2e72900de85a1e2ffbc9470df05794242b82b9/src/dbwrapper.cpp#L23</a>
<br>
</div>

<div class='talk op-msg' data-timestamp='1445699040' id='431949'>
<a class='timestamp' href='#431949'><time timestamp='2015-10-24T15:04:00Z'>15:04</time></a>
&lt;<span class='nick nick-13'> sipa</span>&gt;
oh, yes!
<br>
</div>

<div class='talk op-msg' data-timestamp='1445699160' id='431950'>
<a class='timestamp' href='#431950'><time timestamp='2015-10-24T15:06:00Z'>15:06</time></a>
&lt;<span class='nick nick-13'> sipa</span>&gt;
i&#x27;m just saying, no need for a new GetArg, there is already logic for this in init.cpp
<br>
</div>

<div class='talk op-msg' data-timestamp='1445699220' id='431951'>
<a class='timestamp' href='#431951'><time timestamp='2015-10-24T15:07:00Z'>15:07</time></a>
&lt;<span class='nick nick-5'> jgarzik</span>&gt;
yep
<br>
</div>

<div class='talk op-msg' data-timestamp='1445699400' id='431952'>
<a class='timestamp' href='#431952'><time timestamp='2015-10-24T15:10:00Z'>15:10</time></a>
&lt;<span class='nick nick-13'> sipa</span>&gt;
note that the chainstate only really has a durability requirement when pruning
<br>
</div>

<div class='talk op-msg' data-timestamp='1445699400' id='431953'>
<a class='timestamp' href='#431953'><time timestamp='2015-10-24T15:10:00Z'>15:10</time></a>
&lt;<span class='nick nick-13'> sipa</span>&gt;
otherwise, any old but consistent state is acceptable
<br>
</div>

<div class='talk op-msg' data-timestamp='1445699460' id='431954'>
<a class='timestamp' href='#431954'><time timestamp='2015-10-24T15:11:00Z'>15:11</time></a>
&lt;<span class='nick nick-13'> sipa</span>&gt;
though blockindex flushes are hard requirements
<br>
</div>

<div class='talk op-msg' data-timestamp='1445699580' id='431955'>
<a class='timestamp' href='#431955'><time timestamp='2015-10-24T15:13:00Z'>15:13</time></a>
&lt;<span class='nick nick-5'> jgarzik</span>&gt;
I would like to separate things out into multiple tables
<br>
</div>

<div class='talk op-msg' data-timestamp='1445699640' id='431956'>
<a class='timestamp' href='#431956'><time timestamp='2015-10-24T15:14:00Z'>15:14</time></a>
&lt;<span class='nick nick-5'> jgarzik</span>&gt;
(as sipa mentioned days ago)
<br>
</div>

<div class='talk op-msg' data-timestamp='1445699700' id='431957'>
<a class='timestamp' href='#431957'><time timestamp='2015-10-24T15:15:00Z'>15:15</time></a>
&lt;<span class='nick nick-13'> sipa</span>&gt;
i&#x27;m surprised you didn&#x27;t need to yet
<br>
</div>

<div class='talk op-msg' data-timestamp='1445699700' id='431958'>
<a class='timestamp' href='#431958'><time timestamp='2015-10-24T15:15:00Z'>15:15</time></a>
&lt;<span class='nick nick-13'> sipa</span>&gt;
can transactions span multiple tables?
<br>
</div>

<div class='talk op-msg' data-timestamp='1445699760' id='431959'>
<a class='timestamp' href='#431959'><time timestamp='2015-10-24T15:16:00Z'>15:16</time></a>
&lt;<span class='nick nick-5'> jgarzik</span>&gt;
yes
<br>
</div>

<div class='talk op-msg' data-timestamp='1445699760' id='431960'>
<a class='timestamp' href='#431960'><time timestamp='2015-10-24T15:16:00Z'>15:16</time></a>
&lt;<span class='nick nick-13'> sipa</span>&gt;
in that, you probably want to split it
<br>
</div>

<div class='talk op-msg' data-timestamp='1445700180' id='431961'>
<a class='timestamp' href='#431961'><time timestamp='2015-10-24T15:23:00Z'>15:23</time></a>
&lt;<span class='nick nick-5'> jgarzik</span>&gt;
wumpus, One concern with the current implementation is the &#x27;ORDER BY&#x27; - a sort - in the CDBIterator class.  Once fully sync&#x27;d to current bitcoin block height, failing to store in an always-sorted container may create lumpy bitcoind behavior whenever CDBIterator is used... maybe.  
<br>
</div>

<div class='talk op-msg' data-timestamp='1445700180' id='431962'>
<a class='timestamp' href='#431962'><time timestamp='2015-10-24T15:23:00Z'>15:23</time></a>
&lt;<span class='nick nick-5'> jgarzik</span>&gt;
Needs testing to disprove hypothesis.
<br>
</div>

<div class='talk op-msg' data-timestamp='1445700240' id='431963'>
<a class='timestamp' href='#431963'><time timestamp='2015-10-24T15:24:00Z'>15:24</time></a>
&lt;<span class='nick nick-5'> jgarzik</span>&gt;
possibly either the sort is fast enough or smart enough that this is not noticed
<br>
</div>

<div class='talk op-msg' data-timestamp='1445700240' id='431964'>
<a class='timestamp' href='#431964'><time timestamp='2015-10-24T15:24:00Z'>15:24</time></a>
&lt;<span class='nick nick-16'> wumpus</span>&gt;
yes, depends on the kind of index
<br>
</div>

<div class='talk op-msg' data-timestamp='1445700300' id='431965'>
<a class='timestamp' href='#431965'><time timestamp='2015-10-24T15:25:00Z'>15:25</time></a>
&lt;<span class='nick nick-16'> wumpus</span>&gt;
I suppose the default is a sorted index
<br>
</div>

<div class='talk op-msg' data-timestamp='1445700360' id='431966'>
<a class='timestamp' href='#431966'><time timestamp='2015-10-24T15:26:00Z'>15:26</time></a>
&lt;<span class='nick nick-16'> wumpus</span>&gt;
something like a hash index on the key would indeed break the assumption that CDbIterator always returns the results in order
<br>
</div>

<div class='talk op-msg' data-timestamp='1445700420' id='431967'>
<a class='timestamp' href='#431967'><time timestamp='2015-10-24T15:27:00Z'>15:27</time></a>
&lt;<span class='nick nick-5'> jgarzik</span>&gt;
well not break - slow down
<br>
</div>

<div class='talk op-msg' data-timestamp='1445700420' id='431968'>
<a class='timestamp' href='#431968'><time timestamp='2015-10-24T15:27:00Z'>15:27</time></a>
&lt;<span class='nick nick-5'> jgarzik</span>&gt;
&#x27;ORDER BY&#x27; provides the ordering guarantee in case the underlying db does not, in this implementation
<br>
</div>

<div class='talk op-msg' data-timestamp='1445700420' id='431969'>
<a class='timestamp' href='#431969'><time timestamp='2015-10-24T15:27:00Z'>15:27</time></a>
&lt;<span class='nick nick-16'> wumpus</span>&gt;
yeah... but an in-database sort of a whole table really isn&#x27;t pretty
<br>
</div>

<div class='talk op-msg' data-timestamp='1445700420' id='431970'>
<a class='timestamp' href='#431970'><time timestamp='2015-10-24T15:27:00Z'>15:27</time></a>
&lt;<span class='nick nick-5'> jgarzik</span>&gt;
nod
<br>
</div>

<div class='talk op-msg' data-timestamp='1445700480' id='431971'>
<a class='timestamp' href='#431971'><time timestamp='2015-10-24T15:28:00Z'>15:28</time></a>
&lt;<span class='nick nick-16'> wumpus</span>&gt;
I guess it&#x27;s best to just use a sorted index for now, unless it proves to be a bottleneck
<br>
</div>

<div class='talk op-msg' data-timestamp='1445700480' id='431972'>
<a class='timestamp' href='#431972'><time timestamp='2015-10-24T15:28:00Z'>15:28</time></a>
&lt;<span class='nick nick-5'> jgarzik</span>&gt;
it&#x27;s a partial sort, starting at the base key
<br>
</div>

<div class='talk op-msg' data-timestamp='1445700480' id='431973'>
<a class='timestamp' href='#431973'><time timestamp='2015-10-24T15:28:00Z'>15:28</time></a>
&lt;<span class='nick nick-5'> jgarzik</span>&gt;
not a whole-table sort
<br>
</div>

<div class='talk op-msg' data-timestamp='1445700480' id='431974'>
<a class='timestamp' href='#431974'><time timestamp='2015-10-24T15:28:00Z'>15:28</time></a>
&lt;<span class='nick nick-16'> wumpus</span>&gt;
don&#x27;t we only use iterators over the whole table?
<br>
</div>

<div class='talk op-msg' data-timestamp='1445700480' id='431975'>
<a class='timestamp' href='#431975'><time timestamp='2015-10-24T15:28:00Z'>15:28</time></a>
&lt;<span class='nick nick-5'> jgarzik</span>&gt;
not needed 
<br>
</div>

<div class='talk op-msg' data-timestamp='1445700540' id='431976'>
<a class='timestamp' href='#431976'><time timestamp='2015-10-24T15:29:00Z'>15:29</time></a>
&lt;<span class='nick nick-5'> jgarzik</span>&gt;
code has one pattern:  seek(key) then next() next() next()
<br>
</div>

<div class='talk op-msg' data-timestamp='1445700540' id='431977'>
<a class='timestamp' href='#431977'><time timestamp='2015-10-24T15:29:00Z'>15:29</time></a>
&lt;<span class='nick nick-16'> wumpus</span>&gt;
then again - without an ordered index, the &gt;= criteria on the key will also cause a full scan
<br>
</div>

<div class='talk op-msg' data-timestamp='1445700540' id='431978'>
<a class='timestamp' href='#431978'><time timestamp='2015-10-24T15:29:00Z'>15:29</time></a>
&lt;<span class='nick nick-5'> jgarzik</span>&gt;
yep that is actually an option - assuming results can be unorder - drop &#x27;ORDER BY&#x27; and simply scan
<br>
</div>

<div class='talk op-msg' data-timestamp='1445700600' id='431979'>
<a class='timestamp' href='#431979'><time timestamp='2015-10-24T15:30:00Z'>15:30</time></a>
&lt;<span class='nick nick-7'> * jgarzik</span>&gt;
wonders how to tune index types
<br>
</div>

<div class='talk op-msg' data-timestamp='1445700600' id='431980'>
<a class='timestamp' href='#431980'><time timestamp='2015-10-24T15:30:00Z'>15:30</time></a>
&lt;<span class='nick nick-16'> wumpus</span>&gt;
yeah, that&#x27;s the same as the database does internally. I suggest just sticking with a sorted index, unless it turns out to be really a problem, this is unwanted uglyness
<br>
</div>

<div class='talk op-msg' data-timestamp='1445700660' id='431981'>
<a class='timestamp' href='#431981'><time timestamp='2015-10-24T15:31:00Z'>15:31</time></a>
&lt;<span class='nick nick-8'> jcorgan</span>&gt;
wumpus, what did you end up with for the list of pragmas 
<br>
</div>

<div class='talk op-msg' data-timestamp='1445700720' id='431982'>
<a class='timestamp' href='#431982'><time timestamp='2015-10-24T15:32:00Z'>15:32</time></a>
&lt;<span class='nick nick-8'> jcorgan</span>&gt;
WAL isn&#x27;t making any difference for me
<br>
</div>

<div class='talk op-msg' data-timestamp='1445700780' id='431983'>
<a class='timestamp' href='#431983'><time timestamp='2015-10-24T15:33:00Z'>15:33</time></a>
&lt;<span class='nick nick-16'> wumpus</span>&gt;
good question though: do any of the CDBIterator clients require the records to be in a defined order?
<br>
</div>

<div class='talk op-msg' data-timestamp='1445700900' id='431984'>
<a class='timestamp' href='#431984'><time timestamp='2015-10-24T15:35:00Z'>15:35</time></a>
&lt;<span class='nick nick-5'> jgarzik</span>&gt;
<a href="https://www.sqlite.org/withoutrowid.html" class="link" target="_blank">https://www.sqlite.org/withoutrowid.html</a>
<br>
</div>

<div class='talk op-msg' data-timestamp='1445700900' id='431985'>
<a class='timestamp' href='#431985'><time timestamp='2015-10-24T15:35:00Z'>15:35</time></a>
&lt;<span class='nick nick-16'> wumpus</span>&gt;
looks like they don&#x27;t: their only requirement is that the keys are in a certain range, because the prefix defines what &#x27;table&#x27; they are in
<br>
</div>

<div class='talk op-msg' data-timestamp='1445700960' id='431986'>
<a class='timestamp' href='#431986'><time timestamp='2015-10-24T15:36:00Z'>15:36</time></a>
&lt;<span class='nick nick-5'> jgarzik</span>&gt;
wumpus, as of now they are within a certain -start- range; end is not excised
<br>
</div>

<div class='talk op-msg' data-timestamp='1445700960' id='431987'>
<a class='timestamp' href='#431987'><time timestamp='2015-10-24T15:36:00Z'>15:36</time></a>
&lt;<span class='nick nick-16'> wumpus</span>&gt;
jcorgan: PRAGMA wal_autocheckpoint=0
<br>
</div>

<div class='talk op-msg' data-timestamp='1445700960' id='431988'>
<a class='timestamp' href='#431988'><time timestamp='2015-10-24T15:36:00Z'>15:36</time></a>
&lt;<span class='nick nick-16'> wumpus</span>&gt;
jgarzik: the end is too - by breaking out of the iterator as soon as prefix no longer matches
<br>
</div>

<div class='talk op-msg' data-timestamp='1445700960' id='431989'>
<a class='timestamp' href='#431989'><time timestamp='2015-10-24T15:36:00Z'>15:36</time></a>
&lt;<span class='nick nick-8'> jcorgan</span>&gt;
got it
<br>
</div>

<div class='talk op-msg' data-timestamp='1445700960' id='431990'>
<a class='timestamp' href='#431990'><time timestamp='2015-10-24T15:36:00Z'>15:36</time></a>
&lt;<span class='nick nick-16'> wumpus</span>&gt;
jgarzik: sure, that could be part of the API
<br>
</div>

<div class='talk op-msg' data-timestamp='1445700960' id='431991'>
<a class='timestamp' href='#431991'><time timestamp='2015-10-24T15:36:00Z'>15:36</time></a>
&lt;<span class='nick nick-5'> jgarzik</span>&gt;
wumpus, nod - thus sort is required - otherwise iteration ends prematurely
<br>
</div>

<div class='talk op-msg' data-timestamp='1445701020' id='431992'>
<a class='timestamp' href='#431992'><time timestamp='2015-10-24T15:37:00Z'>15:37</time></a>
&lt;<span class='nick nick-5'> jgarzik</span>&gt;
it works if you can do &quot;&gt;= start_key&quot; and &quot;&lt; next_prefix&quot; and know what next_prefix is
<br>
</div>

<div class='talk op-msg' data-timestamp='1445701020' id='431993'>
<a class='timestamp' href='#431993'><time timestamp='2015-10-24T15:37:00Z'>15:37</time></a>
&lt;<span class='nick nick-16'> wumpus</span>&gt;
my pointi s that the sort would not be required when the records would be binned in a different way, for example in different tables, instead ofusing a prefix to distinguish them
<br>
</div>

<div class='talk op-msg' data-timestamp='1445701020' id='431994'>
<a class='timestamp' href='#431994'><time timestamp='2015-10-24T15:37:00Z'>15:37</time></a>
&lt;<span class='nick nick-16'> wumpus</span>&gt;
they don&#x27;t rely on the fact that keys are sorted
<br>
</div>

<div class='talk op-msg' data-timestamp='1445701020' id='431995'>
<a class='timestamp' href='#431995'><time timestamp='2015-10-24T15:37:00Z'>15:37</time></a>
&lt;<span class='nick nick-5'> jgarzik</span>&gt;
wumpus, agreed there - hence  &lt;jgarzik&gt; I would like to separate things out into multiple tables
<br>
</div>

<div class='talk op-msg' data-timestamp='1445701080' id='431996'>
<a class='timestamp' href='#431996'><time timestamp='2015-10-24T15:38:00Z'>15:38</time></a>
&lt;<span class='nick nick-16'> wumpus</span>&gt;
in the case of the UTXO database this doesn&#x27;t matter that much because it <b>*almost*</b> only contains COINS entries
<br>
</div>

<div class='talk op-msg' data-timestamp='1445701080' id='431997'>
<a class='timestamp' href='#431997'><time timestamp='2015-10-24T15:38:00Z'>15:38</time></a>
&lt;<span class='nick nick-16'> wumpus</span>&gt;
for the blockdb on the other hand, it can contain these txindex entries...
<br>
</div>

<div class='talk op-msg' data-timestamp='1445701140' id='431998'>
<a class='timestamp' href='#431998'><time timestamp='2015-10-24T15:39:00Z'>15:39</time></a>
&lt;<span class='nick nick-5'> jgarzik</span>&gt;
wumpus, what is your total diff versus 2015_sqlite, WRT pragmas?  can you paste that?
<br>
</div>

<div class='talk op-msg' data-timestamp='1445701140' id='431999'>
<a class='timestamp' href='#431999'><time timestamp='2015-10-24T15:39:00Z'>15:39</time></a>
&lt;<span class='nick nick-16'> wumpus</span>&gt;
(and a lot of them, the number of block entries is neglible comparison)
<br>
</div>

<div class='talk op-msg' data-timestamp='1445701140' id='432000'>
<a class='timestamp' href='#432000'><time timestamp='2015-10-24T15:39:00Z'>15:39</time></a>
&lt;<span class='nick nick-5'> jgarzik</span>&gt;
I want to put that in 2015_sqlite
<br>
</div>

<div class='talk op-msg' data-timestamp='1445701200' id='432001'>
<a class='timestamp' href='#432001'><time timestamp='2015-10-24T15:40:00Z'>15:40</time></a>
&lt;<span class='nick nick-16'> wumpus</span>&gt;
+    &quot;PRAGMA wal_autocheckpoint=0&quot;,
<br>
</div>

<div class='talk op-msg' data-timestamp='1445701200' id='432002'>
<a class='timestamp' href='#432002'><time timestamp='2015-10-24T15:40:00Z'>15:40</time></a>
&lt;<span class='nick nick-16'> wumpus</span>&gt;
+    &quot;PRAGMA journal_mode=WAL&quot;,
<br>
</div>

<div class='talk op-msg' data-timestamp='1445701200' id='432003'>
<a class='timestamp' href='#432003'><time timestamp='2015-10-24T15:40:00Z'>15:40</time></a>
&lt;<span class='nick nick-8'> jcorgan</span>&gt;
isn&#x27;t that supposed to be schema.journal_mode ?
<br>
</div>

<div class='talk op-msg' data-timestamp='1445701260' id='432004'>
<a class='timestamp' href='#432004'><time timestamp='2015-10-24T15:41:00Z'>15:41</time></a>
&lt;<span class='nick nick-5'> jgarzik</span>&gt;
global is fine
<br>
</div>

<div class='talk op-msg' data-timestamp='1445701260' id='432005'>
<a class='timestamp' href='#432005'><time timestamp='2015-10-24T15:41:00Z'>15:41</time></a>
&lt;<span class='nick nick-16'> wumpus</span>&gt;
I prefer setting the global option
<br>
</div>

<div class='talk op-msg' data-timestamp='1445701260' id='432006'>
<a class='timestamp' href='#432006'><time timestamp='2015-10-24T15:41:00Z'>15:41</time></a>
&lt;<span class='nick nick-8'> jcorgan</span>&gt;
ok
<br>
</div>

<div class='talk op-msg' data-timestamp='1445701260' id='432007'>
<a class='timestamp' href='#432007'><time timestamp='2015-10-24T15:41:00Z'>15:41</time></a>
&lt;<span class='nick nick-16'> wumpus</span>&gt;
(it&#x27;s possible to set it per schema)
<br>
</div>

<div class='talk op-msg' data-timestamp='1445701260' id='432008'>
<a class='timestamp' href='#432008'><time timestamp='2015-10-24T15:41:00Z'>15:41</time></a>
&lt;<span class='nick nick-16'> wumpus</span>&gt;
(but do we even define those?)
<br>
</div>

<div class='talk op-msg' data-timestamp='1445701320' id='432009'>
<a class='timestamp' href='#432009'><time timestamp='2015-10-24T15:42:00Z'>15:42</time></a>
&lt;<span class='nick nick-5'> jgarzik</span>&gt;
no need
<br>
</div>

<div class='talk op-msg' data-timestamp='1445701320' id='432010'>
<a class='timestamp' href='#432010'><time timestamp='2015-10-24T15:42:00Z'>15:42</time></a>
&lt;<span class='nick nick-16'> wumpus</span>&gt;
using schema.journal mode <b>*literally*</b> fails, that was my first try too :)
<br>
</div>

<div class='talk op-msg' data-timestamp='1445701320' id='432011'>
<a class='timestamp' href='#432011'><time timestamp='2015-10-24T15:42:00Z'>15:42</time></a>
&lt;<span class='nick nick-5'> jgarzik</span>&gt;
wumpus, well, of course it will fail, first time the table does not exist
<br>
</div>

<div class='talk op-msg' data-timestamp='1445701380' id='432012'>
<a class='timestamp' href='#432012'><time timestamp='2015-10-24T15:43:00Z'>15:43</time></a>
&lt;<span class='nick nick-5'> jgarzik</span>&gt;
stmts can be reorders but ... setting the global is best
<br>
</div>

<div class='talk op-msg' data-timestamp='1445701380' id='432013'>
<a class='timestamp' href='#432013'><time timestamp='2015-10-24T15:43:00Z'>15:43</time></a>
&lt;<span class='nick nick-16'> wumpus</span>&gt;
but setting the global one works, so yeah...
<br>
</div>

<div class='talk op-msg' data-timestamp='1445701380' id='432014'>
<a class='timestamp' href='#432014'><time timestamp='2015-10-24T15:43:00Z'>15:43</time></a>
&lt;<span class='nick nick-5'> jgarzik</span>&gt;
reordered
<br>
</div>

<div class='talk op-msg' data-timestamp='1445701440' id='432015'>
<a class='timestamp' href='#432015'><time timestamp='2015-10-24T15:44:00Z'>15:44</time></a>
&lt;<span class='nick nick-5'> jgarzik</span>&gt;
OK, pushed out WAL &amp; improved errors to 2015_sqlite
<br>
</div>

<div class='talk op-msg' data-timestamp='1445701440' id='432016'>
<a class='timestamp' href='#432016'><time timestamp='2015-10-24T15:44:00Z'>15:44</time></a>
&lt;<span class='nick nick-5'> jgarzik</span>&gt;
going to task switch, poke me if there are other updates for the branch
<br>
</div>

<div class='talk op-msg' data-timestamp='1445701440' id='432017'>
<a class='timestamp' href='#432017'><time timestamp='2015-10-24T15:44:00Z'>15:44</time></a>
&lt;<span class='nick nick-8'> jcorgan</span>&gt;
i&#x27;ll time the total reindex with the new stuff
<br>
</div>

<div class='talk op-msg' data-timestamp='1445701560' id='432018'>
<a class='timestamp' href='#432018'><time timestamp='2015-10-24T15:46:00Z'>15:46</time></a>
&lt;<span class='nick nick-8'> jcorgan</span>&gt;
huge difference with the pragmas
<br>
</div>

<div class='talk op-msg' data-timestamp='1445701740' id='432019'>
<a class='timestamp' href='#432019'><time timestamp='2015-10-24T15:49:00Z'>15:49</time></a>
&lt;<span class='nick nick-5'> jgarzik</span>&gt;
Thanks.  If someone is so motivated, timing with different page sizes (1024 4096, 8192) can be useful.  Page size goes all the way up to 64k.
<br>
</div>

<div class='talk op-msg' data-timestamp='1445701800' id='432020'>
<a class='timestamp' href='#432020'><time timestamp='2015-10-24T15:50:00Z'>15:50</time></a>
&lt;<span class='nick nick-16'> wumpus</span>&gt;
wouldn&#x27;t the optimal page size depend on the hardware as well? would be good to do some benchmarks, for example do a full reindex with various sets of parameters, but I don&#x27;t have a system I can use for controlled tests without background noise
<br>
</div>

<div class='talk op-msg' data-timestamp='1445701860' id='432021'>
<a class='timestamp' href='#432021'><time timestamp='2015-10-24T15:51:00Z'>15:51</time></a>
&lt;<span class='nick nick-16'> wumpus</span>&gt;
-stopafterblockimport is a great option for timed, batched reindexes, though
<br>
</div>

<div class='talk op-msg' data-timestamp='1445701980' id='432022'>
<a class='timestamp' href='#432022'><time timestamp='2015-10-24T15:53:00Z'>15:53</time></a>
&lt;<span class='nick nick-8'> jcorgan</span>&gt;
i suspect it would be very filesystem and storage configuration dependent
<br>
</div>

<div class='talk op-msg' data-timestamp='1445702160' id='432023'>
<a class='timestamp' href='#432023'><time timestamp='2015-10-24T15:56:00Z'>15:56</time></a>
&lt;<span class='nick nick-16'> wumpus</span>&gt;
btw it could be that we need to call sqlite3_wal_checkpoint_v2 at some point (eg, when flushing) with autocheckpointing disabled
<br>
</div>

<div class='talk op-msg' data-timestamp='1445702280' id='432024'>
<a class='timestamp' href='#432024'><time timestamp='2015-10-24T15:58:00Z'>15:58</time></a>
&lt;<span class='nick nick-16'> wumpus</span>&gt;
&quot;Writers sync the WAL on every transaction commit if PRAGMA synchronous is set to FULL but omit this sync if PRAGMA synchronous is set to NORMAL.&quot; or maybe not. Pragma synchronous is FULL by default. I&#x27;m not sure how the checkpoints come into it.
<br>
</div>

<div class='talk op-msg' data-timestamp='1445702280' id='432025'>
<a class='timestamp' href='#432025'><time timestamp='2015-10-24T15:58:00Z'>15:58</time></a>
&lt;<span class='nick nick-16'> wumpus</span>&gt;
syncing on transaction commit sounds sane
<br>
</div>

<div class='talk op-msg' data-timestamp='1445702340' id='432026'>
<a class='timestamp' href='#432026'><time timestamp='2015-10-24T15:59:00Z'>15:59</time></a>
&lt;<span class='nick nick-8'> jcorgan</span>&gt;
yes
<br>
</div>

<div class='talk op-msg' data-timestamp='1445703060' id='432027'>
<a class='timestamp' href='#432027'><time timestamp='2015-10-24T16:11:00Z'>16:11</time></a>
&lt;<span class='nick nick-16'> wumpus</span>&gt;
after running a while, bitcoin-shutoff is taking a long time in sqlite3_close - possibly due to the lack of checkpoints
<br>
</div>

<div class='talk op-msg' data-timestamp='1445703240' id='432028'>
<a class='timestamp' href='#432028'><time timestamp='2015-10-24T16:14:00Z'>16:14</time></a>
&lt;<span class='nick nick-16'> wumpus</span>&gt;
... -rw------- 1 39G Oct 24 18:06 db-wal    probably
<br>
</div>

<div class='talk op-msg' data-timestamp='1445703360' id='432029'>
<a class='timestamp' href='#432029'><time timestamp='2015-10-24T16:16:00Z'>16:16</time></a>
&lt;<span class='nick nick-16'> wumpus</span>&gt;
finished now
<br>
</div>

<div class='talk op-msg' data-timestamp='1445703360' id='432030'>
<a class='timestamp' href='#432030'><time timestamp='2015-10-24T16:16:00Z'>16:16</time></a>
&lt;<span class='nick nick-13'> sipa</span>&gt;
ugh
<br>
</div>

<div class='talk op-msg' data-timestamp='1445703420' id='432031'>
<a class='timestamp' href='#432031'><time timestamp='2015-10-24T16:17:00Z'>16:17</time></a>
&lt;<span class='nick nick-5'> jgarzik</span>&gt;
&quot;Avoiding Excessively Large WAL Files&quot; is a big section in <a href="https://www.sqlite.org/wal.html" class="link" target="_blank">https://www.sqlite.org/wal.html</a> :)
<br>
</div>

<div class='talk op-msg' data-timestamp='1445703480' id='432032'>
<a class='timestamp' href='#432032'><time timestamp='2015-10-24T16:18:00Z'>16:18</time></a>
&lt;<span class='nick nick-5'> jgarzik</span>&gt;
RE optimal page size - ideally it is an &quot;I/O unit&quot; which is filesystem block size - but large dbs might gain from clustering.  Also, modern filesystems are kernel-page-cache based, and so an I/O unit in practice is often 4096 or 8192.
<br>
</div>

<div class='talk op-msg' data-timestamp='1445703540' id='432033'>
<a class='timestamp' href='#432033'><time timestamp='2015-10-24T16:19:00Z'>16:19</time></a>
&lt;<span class='nick nick-16'> wumpus</span>&gt;
jgarzik: yes - probably setting the page size to anything less than 4096 is not going to be useful
<br>
</div>

<div class='talk op-msg' data-timestamp='1445703600' id='432034'>
<a class='timestamp' href='#432034'><time timestamp='2015-10-24T16:20:00Z'>16:20</time></a>
&lt;<span class='nick nick-16'> wumpus</span>&gt;
(at least not on linux)
<br>
</div>

<div class='talk op-msg' data-timestamp='1445703780' id='432035'>
<a class='timestamp' href='#432035'><time timestamp='2015-10-24T16:23:00Z'>16:23</time></a>
&lt;<span class='nick nick-16'> wumpus</span>&gt;
adding &quot;rrc = sqlite3_wal_checkpoint_v2(psql, NULL, SQLITE_CHECKPOINT_PASSIVE, NULL, NULL);&quot; at the end of WriteBatch indeed stops the wal file from growing... but, makes the flush slow (~30 seconds) again :/
<br>
</div>

<div class='talk op-msg' data-timestamp='1445703900' id='432036'>
<a class='timestamp' href='#432036'><time timestamp='2015-10-24T16:25:00Z'>16:25</time></a>
&lt;<span class='nick nick-7'> * jgarzik</span>&gt;
reverted 2015_sqlite back to default autocheckpointing behavior...  plenty of room for further research &amp; experiments
<br>
</div>

<div class='talk op-msg' data-timestamp='1445703900' id='432037'>
<a class='timestamp' href='#432037'><time timestamp='2015-10-24T16:25:00Z'>16:25</time></a>
&lt;<span class='nick nick-5'> jgarzik</span>&gt;
I think there is a background WAL checkpoint mode
<br>
</div>

<div class='talk op-msg' data-timestamp='1445703900' id='432038'>
<a class='timestamp' href='#432038'><time timestamp='2015-10-24T16:25:00Z'>16:25</time></a>
&lt;<span class='nick nick-16'> wumpus</span>&gt;
so I&#x27;m not sure when to do these checkpoints
<br>
</div>

<div class='talk op-msg' data-timestamp='1445703900' id='432039'>
<a class='timestamp' href='#432039'><time timestamp='2015-10-24T16:25:00Z'>16:25</time></a>
&lt;<span class='nick nick-16'> wumpus</span>&gt;
the default autocheckpointing does a checkpoint every 1000 statements or so, that is probably even worse
<br>
</div>

<div class='talk op-msg' data-timestamp='1445703960' id='432040'>
<a class='timestamp' href='#432040'><time timestamp='2015-10-24T16:26:00Z'>16:26</time></a>
&lt;<span class='nick nick-5'> jgarzik</span>&gt;
nod - it&#x27;s a stable base for further research, not an endpoint
<br>
</div>

<div class='talk op-msg' data-timestamp='1445703960' id='432041'>
<a class='timestamp' href='#432041'><time timestamp='2015-10-24T16:26:00Z'>16:26</time></a>
&lt;<span class='nick nick-5'> jgarzik</span>&gt;
the main goal is to not-wait for checkpoint, not not-checkpoint
<br>
</div>

<div class='talk op-msg' data-timestamp='1445703960' id='432042'>
<a class='timestamp' href='#432042'><time timestamp='2015-10-24T16:26:00Z'>16:26</time></a>
&lt;<span class='nick nick-16'> wumpus</span>&gt;
yes but we want checkpoints only to happen on commit, not inbetween
<br>
</div>

<div class='talk op-msg' data-timestamp='1445704020' id='432043'>
<a class='timestamp' href='#432043'><time timestamp='2015-10-24T16:27:00Z'>16:27</time></a>
&lt;<span class='nick nick-16'> wumpus</span>&gt;
I think the default does so, not sure though... didn&#x27;t expect manual calls to sqlite3_wal_checkpoint_v2 to be so slow even when done once per transaction
<br>
</div>

<div class='talk op-msg' data-timestamp='1445704080' id='432044'>
<a class='timestamp' href='#432044'><time timestamp='2015-10-24T16:28:00Z'>16:28</time></a>
&lt;<span class='nick nick-16'> wumpus</span>&gt;
doing it in the background would be nice
<br>
</div>

<div class='talk op-msg' data-timestamp='1445704080' id='432045'>
<a class='timestamp' href='#432045'><time timestamp='2015-10-24T16:28:00Z'>16:28</time></a>
&lt;<span class='nick nick-16'> wumpus</span>&gt;
but then &quot;Checkpointing needs to lock the entire database, so all other readers and writes would have to be blocked. (A passive checkpoint just aborts.)&quot;
<br>
</div>

<div class='talk op-msg' data-timestamp='1445704200' id='432046'>
<a class='timestamp' href='#432046'><time timestamp='2015-10-24T16:30:00Z'>16:30</time></a>
&lt;<span class='nick nick-16'> wumpus</span>&gt;
so I&#x27;m not sure how much doing the checkpointing in a thread would help in practice. If you do PASSIVE checkpoints they&#x27;ll never happen at all, and the other modes do waiting in one way or another
<br>
</div>

<div class='talk op-msg' data-timestamp='1445704200' id='432047'>
<a class='timestamp' href='#432047'><time timestamp='2015-10-24T16:30:00Z'>16:30</time></a>
&lt;<span class='nick nick-8'> jcorgan</span>&gt;
whouda thunk that getting database operations right would be as hard as getting crypto right? :-)
<br>
</div>

<div class='talk op-msg' data-timestamp='1445704200' id='432048'>
<a class='timestamp' href='#432048'><time timestamp='2015-10-24T16:30:00Z'>16:30</time></a>
&lt;<span class='nick nick-16'> wumpus</span>&gt;
well I&#x27;m not sure it&#x27;s as hard as getting crypto right :) but yes it&#x27;s not trivial
<br>
</div>

<div class='talk op-msg' data-timestamp='1445704260' id='432049'>
<a class='timestamp' href='#432049'><time timestamp='2015-10-24T16:31:00Z'>16:31</time></a>
&lt;<span class='nick nick-16'> wumpus</span>&gt;
but seeing all of this it seems leveldb isn&#x27;t so bad at all
<br>
</div>

<div class='talk op-msg' data-timestamp='1445704320' id='432050'>
<a class='timestamp' href='#432050'><time timestamp='2015-10-24T16:32:00Z'>16:32</time></a>
&lt;<span class='nick nick-5'> jgarzik</span>&gt;
switching major database system types, one expects some analysis and bumps in understanding the new system
<br>
</div>

<div class='talk op-msg' data-timestamp='1445704320' id='432051'>
<a class='timestamp' href='#432051'><time timestamp='2015-10-24T16:32:00Z'>16:32</time></a>
&lt;<span class='nick nick-13'> sipa</span>&gt;
the only way the wal is cleared is with a checkpoint?
<br>
</div>

<div class='talk op-msg' data-timestamp='1445704320' id='432052'>
<a class='timestamp' href='#432052'><time timestamp='2015-10-24T16:32:00Z'>16:32</time></a>
&lt;<span class='nick nick-16'> wumpus</span>&gt;
yes, and this is only an experiment
<br>
</div>

<div class='talk op-msg' data-timestamp='1445704380' id='432053'>
<a class='timestamp' href='#432053'><time timestamp='2015-10-24T16:33:00Z'>16:33</time></a>
&lt;<span class='nick nick-16'> wumpus</span>&gt;
sipa: yes, &#x27;checkpoint&#x27; seems to be the operation &#x27;incorporate the WAL into the databse&#x27;
<br>
</div>

<div class='talk op-msg' data-timestamp='1445704380' id='432054'>
<a class='timestamp' href='#432054'><time timestamp='2015-10-24T16:33:00Z'>16:33</time></a>
&lt;<span class='nick nick-13'> sipa</span>&gt;
and that operation needs a full exclusive lock on the database?
<br>
</div>

<div class='talk op-msg' data-timestamp='1445704380' id='432055'>
<a class='timestamp' href='#432055'><time timestamp='2015-10-24T16:33:00Z'>16:33</time></a>
&lt;<span class='nick nick-16'> wumpus</span>&gt;
yep
<br>
</div>

<div class='talk op-msg' data-timestamp='1445704380' id='432056'>
<a class='timestamp' href='#432056'><time timestamp='2015-10-24T16:33:00Z'>16:33</time></a>
&lt;<span class='nick nick-13'> sipa</span>&gt;
that&#x27;s unusable
<br>
</div>

<div class='talk op-msg' data-timestamp='1445704440' id='432057'>
<a class='timestamp' href='#432057'><time timestamp='2015-10-24T16:34:00Z'>16:34</time></a>
&lt;<span class='nick nick-5'> jgarzik</span>&gt;
The underlying system calls are range locks, so I wonder
<br>
</div>

<div class='talk op-msg' data-timestamp='1445704440' id='432058'>
<a class='timestamp' href='#432058'><time timestamp='2015-10-24T16:34:00Z'>16:34</time></a>
&lt;<span class='nick nick-5'> jgarzik</span>&gt;
non-WAL updates the db with range locks, I&#x27;m pretty sure
<br>
</div>

<div class='talk op-msg' data-timestamp='1445704440' id='432059'>
<a class='timestamp' href='#432059'><time timestamp='2015-10-24T16:34:00Z'>16:34</time></a>
&lt;<span class='nick nick-13'> sipa</span>&gt;
range locks are useless on a db ordered by random indexes
<br>
</div>

<div class='talk op-msg' data-timestamp='1445704500' id='432060'>
<a class='timestamp' href='#432060'><time timestamp='2015-10-24T16:35:00Z'>16:35</time></a>
&lt;<span class='nick nick-16'> wumpus</span>&gt;
yes there&#x27;s always the normal journal, though non-WAL does an fsync per statement, it seems, its performance was really bad here (and all the fsyncs were making the rest of the system slow, too)
<br>
</div>

<div class='talk op-msg' data-timestamp='1445704560' id='432061'>
<a class='timestamp' href='#432061'><time timestamp='2015-10-24T16:36:00Z'>16:36</time></a>
&lt;<span class='nick nick-5'> jgarzik</span>&gt;
not necessarily - modern schemes write index/data updates to new pages, allowing older pages to be read in parallel (presenting older, committed view of the data)
<br>
</div>

<div class='talk op-msg' data-timestamp='1445704560' id='432062'>
<a class='timestamp' href='#432062'><time timestamp='2015-10-24T16:36:00Z'>16:36</time></a>
&lt;<span class='nick nick-5'> jgarzik</span>&gt;
so you can be writing new while reading old
<br>
</div>

<div class='talk op-msg' data-timestamp='1445704620' id='432063'>
<a class='timestamp' href='#432063'><time timestamp='2015-10-24T16:37:00Z'>16:37</time></a>
&lt;<span class='nick nick-5'> jgarzik</span>&gt;
update-in-place is avoided these days, as it does not produce crash-consistent behavior
<br>
</div>

<div class='talk op-msg' data-timestamp='1445704620' id='432064'>
<a class='timestamp' href='#432064'><time timestamp='2015-10-24T16:37:00Z'>16:37</time></a>
&lt;<span class='nick nick-13'> sipa</span>&gt;
yes, sure
<br>
</div>

<div class='talk op-msg' data-timestamp='1445704620' id='432065'>
<a class='timestamp' href='#432065'><time timestamp='2015-10-24T16:37:00Z'>16:37</time></a>
&lt;<span class='nick nick-13'> sipa</span>&gt;
but you want the background-written log to be incorporated into the real db without locking the whole thing down
<br>
</div>

<div class='talk op-msg' data-timestamp='1445704620' id='432066'>
<a class='timestamp' href='#432066'><time timestamp='2015-10-24T16:37:00Z'>16:37</time></a>
&lt;<span class='nick nick-13'> sipa</span>&gt;
leveldb does that
<br>
</div>

<div class='talk op-msg' data-timestamp='1445704680' id='432067'>
<a class='timestamp' href='#432067'><time timestamp='2015-10-24T16:38:00Z'>16:38</time></a>
&lt;<span class='nick nick-5'> jgarzik</span>&gt;
nod - and that&#x27;s perfectly doable here with range locks - you update the new index, then a quick &quot;flick of a switch&quot; jumps from old consistent state to new consistent state, the latter of which was written in parallel in the background
<br>
</div>

<div class='talk op-msg' data-timestamp='1445704740' id='432068'>
<a class='timestamp' href='#432068'><time timestamp='2015-10-24T16:39:00Z'>16:39</time></a>
&lt;<span class='nick nick-13'> sipa</span>&gt;
every set of wal will touch database entries all over the place
<br>
</div>

<div class='talk op-msg' data-timestamp='1445704800' id='432069'>
<a class='timestamp' href='#432069'><time timestamp='2015-10-24T16:40:00Z'>16:40</time></a>
&lt;<span class='nick nick-13'> sipa</span>&gt;
every non-trivial set.of log entries will need to lock the whole db
<br>
</div>

<div class='talk op-msg' data-timestamp='1445704800' id='432070'>
<a class='timestamp' href='#432070'><time timestamp='2015-10-24T16:40:00Z'>16:40</time></a>
&lt;<span class='nick nick-5'> jgarzik</span>&gt;
same is true for every batch, every database system
<br>
</div>

<div class='talk op-msg' data-timestamp='1445704800' id='432071'>
<a class='timestamp' href='#432071'><time timestamp='2015-10-24T16:40:00Z'>16:40</time></a>
&lt;<span class='nick nick-5'> jgarzik</span>&gt;
again not true - read the above - you don&#x27;t need to lock the whole db in theory - I can&#x27;t speak for sqlite but in database circles the solution is well known here.
<br>
</div>

<div class='talk op-msg' data-timestamp='1445704860' id='432072'>
<a class='timestamp' href='#432072'><time timestamp='2015-10-24T16:41:00Z'>16:41</time></a>
&lt;<span class='nick nick-13'> sipa</span>&gt;
oh of.course
<br>
</div>

<div class='talk op-msg' data-timestamp='1445704860' id='432073'>
<a class='timestamp' href='#432073'><time timestamp='2015-10-24T16:41:00Z'>16:41</time></a>
&lt;<span class='nick nick-13'> sipa</span>&gt;
i&#x27;m just observing sqlite&#x27;s behaviour
<br>
</div>

<div class='talk op-msg' data-timestamp='1445704860' id='432074'>
<a class='timestamp' href='#432074'><time timestamp='2015-10-24T16:41:00Z'>16:41</time></a>
&lt;<span class='nick nick-13'> sipa</span>&gt;
leveldb solves it by having different levels :)
<br>
</div>

<div class='talk op-msg' data-timestamp='1445704860' id='432075'>
<a class='timestamp' href='#432075'><time timestamp='2015-10-24T16:41:00Z'>16:41</time></a>
&lt;<span class='nick nick-13'> sipa</span>&gt;
and no guarantee in which level particular data is to be found
<br>
</div>

<div class='talk op-msg' data-timestamp='1445704860' id='432076'>
<a class='timestamp' href='#432076'><time timestamp='2015-10-24T16:41:00Z'>16:41</time></a>
&lt;<span class='nick nick-13'> sipa</span>&gt;
socchanges can &quot;ripple up&quot;
<br>
</div>

<div class='talk op-msg' data-timestamp='1445704920' id='432077'>
<a class='timestamp' href='#432077'><time timestamp='2015-10-24T16:42:00Z'>16:42</time></a>
&lt;<span class='nick nick-16'> wumpus</span>&gt;
just read <a href="https://www.sqlite.org/c3ref/wal_checkpoint_v2.html" class="link" target="_blank">https://www.sqlite.org/c3ref/wal_checkpoint_v2.html</a> - from what I understand from it, checkpointing requires an exclusive lock and needs to wait for all readers and writers to finish. If there is a way to work around that it&#x27;d be nice, but theory isn&#x27;t of much help here :)
<br>
</div>

<div class='talk op-msg' data-timestamp='1445704980' id='432078'>
<a class='timestamp' href='#432078'><time timestamp='2015-10-24T16:43:00Z'>16:43</time></a>
&lt;<span class='nick nick-5'> jgarzik</span>&gt;
wumpus, that&#x27;s tuned by wal_checkpoint=[passive/full/restart/truncate] a bit
<br>
</div>

<div class='talk op-msg' data-timestamp='1445705040' id='432079'>
<a class='timestamp' href='#432079'><time timestamp='2015-10-24T16:44:00Z'>16:44</time></a>
&lt;<span class='nick nick-16'> wumpus</span>&gt;
tha&#x27;s mentioned in the link I gave, yes. It looks like that determines who gets to wait (or cancel) for whom, not whether the operation requires an exclusive lock
<br>
</div>

<div class='talk op-msg' data-timestamp='1445705100' id='432080'>
<a class='timestamp' href='#432080'><time timestamp='2015-10-24T16:45:00Z'>16:45</time></a>
&lt;<span class='nick nick-13'> sipa</span>&gt;
does issuing a passive checkpoint that gets interrupted make progress?
<br>
</div>

<div class='talk op-msg' data-timestamp='1445705100' id='432081'>
<a class='timestamp' href='#432081'><time timestamp='2015-10-24T16:45:00Z'>16:45</time></a>
&lt;<span class='nick nick-16'> wumpus</span>&gt;
it can
<br>
</div>

<div class='talk op-msg' data-timestamp='1445705760' id='432082'>
<a class='timestamp' href='#432082'><time timestamp='2015-10-24T16:56:00Z'>16:56</time></a>
&lt;<span class='nick nick-16'> wumpus</span>&gt;
doing e.g. SQLITE_CHECKPOINT_FULL or _TRUNCATE from a thread would make sense I suppose - it blocks all writers and some readers: apparently only those readers not reading from the most recent database snapshot
<br>
</div>

<div class='talk op-msg' data-timestamp='1445705760' id='432083'>
<a class='timestamp' href='#432083'><time timestamp='2015-10-24T16:56:00Z'>16:56</time></a>
&lt;<span class='nick nick-16'> wumpus</span>&gt;
at least it wait for all readers to non-recent database snapshot to complete
<br>
</div>

<div class='talk op-msg' data-timestamp='1445705880' id='432084'>
<a class='timestamp' href='#432084'><time timestamp='2015-10-24T16:58:00Z'>16:58</time></a>
&lt;<span class='nick nick-16'> wumpus</span>&gt;
(which makes sense as the old version is effectively discarded)
<br>
</div>

<div class='talk op-msg' data-timestamp='1445705940' id='432085'>
<a class='timestamp' href='#432085'><time timestamp='2015-10-24T16:59:00Z'>16:59</time></a>
&lt;<span class='nick nick-16'> wumpus</span>&gt;
blocking writers is bad during initial sync, but not so much during steady-state where not much updates happen
<br>
</div>

<div class='talk op-msg' data-timestamp='1445706960' id='432086'>
<a class='timestamp' href='#432086'><time timestamp='2015-10-24T17:16:00Z'>17:16</time></a>
&lt;<span class='nick nick-8'> jcorgan</span>&gt;
fyi, this reindex is with txindex=1
<br>
</div>

<div class='talk op-msg' data-timestamp='1445706960' id='432087'>
<a class='timestamp' href='#432087'><time timestamp='2015-10-24T17:16:00Z'>17:16</time></a>
&lt;<span class='nick nick-13'> sipa</span>&gt;
that likely hurts performance
<br>
</div>

<div class='talk op-msg' data-timestamp='1445707020' id='432088'>
<a class='timestamp' href='#432088'><time timestamp='2015-10-24T17:17:00Z'>17:17</time></a>
&lt;<span class='nick nick-13'> sipa</span>&gt;
txindex writes are not batched
<br>
</div>

<div class='talk op-msg' data-timestamp='1445707020' id='432089'>
<a class='timestamp' href='#432089'><time timestamp='2015-10-24T17:17:00Z'>17:17</time></a>
&lt;<span class='nick nick-13'> sipa</span>&gt;
all other database writes are
<br>
</div>

<div class='talk op-msg' data-timestamp='1445707080' id='432090'>
<a class='timestamp' href='#432090'><time timestamp='2015-10-24T17:18:00Z'>17:18</time></a>
&lt;<span class='nick nick-8'> jcorgan</span>&gt;
yeah, it&#x27;s at height 180K and has slowed down dramatically
<br>
</div>

<div class='talk op-msg' data-timestamp='1445707140' id='432091'>
<a class='timestamp' href='#432091'><time timestamp='2015-10-24T17:19:00Z'>17:19</time></a>
&lt;<span class='nick nick-5'> jgarzik</span>&gt;
yeah txindex=1 will slow things down &amp; is not representative
<br>
</div>

<div class='talk op-msg' data-timestamp='1445707140' id='432092'>
<a class='timestamp' href='#432092'><time timestamp='2015-10-24T17:19:00Z'>17:19</time></a>
&lt;<span class='nick nick-13'> sipa</span>&gt;
i consider txindex something you need for debugging/diagnostics, not for production use
<br>
</div>

<div class='talk op-msg' data-timestamp='1445707140' id='432093'>
<a class='timestamp' href='#432093'><time timestamp='2015-10-24T17:19:00Z'>17:19</time></a>
&lt;<span class='nick nick-16'> wumpus</span>&gt;
agreed
<br>
</div>

<div class='talk op-msg' data-timestamp='1445707140' id='432094'>
<a class='timestamp' href='#432094'><time timestamp='2015-10-24T17:19:00Z'>17:19</time></a>
&lt;<span class='nick nick-8'> jcorgan</span>&gt;
let me redo it then
<br>
</div>

<div class='talk op-msg' data-timestamp='1445707200' id='432095'>
<a class='timestamp' href='#432095'><time timestamp='2015-10-24T17:20:00Z'>17:20</time></a>
&lt;<span class='nick nick-13'> sipa</span>&gt;
that said, it shouldn&#x27;t gratuitously kill performance if there is an easy way around it
<br>
</div>

<div class='talk op-msg' data-timestamp='1445707260' id='432096'>
<a class='timestamp' href='#432096'><time timestamp='2015-10-24T17:21:00Z'>17:21</time></a>
&lt;<span class='nick nick-13'> sipa</span>&gt;
i also doubt that anything you notice at 180k is due to that
<br>
</div>

<div class='talk op-msg' data-timestamp='1445707320' id='432097'>
<a class='timestamp' href='#432097'><time timestamp='2015-10-24T17:22:00Z'>17:22</time></a>
&lt;<span class='nick nick-8'> jcorgan</span>&gt;
i don&#x27;t know that it started at 180k, just that was where it was when i check in on it
<br>
</div>

<div class='talk op-msg' data-timestamp='1445707380' id='432098'>
<a class='timestamp' href='#432098'><time timestamp='2015-10-24T17:23:00Z'>17:23</time></a>
&lt;<span class='nick nick-16'> wumpus</span>&gt;
don&#x27;t you mean 280k?
<br>
</div>

<div class='talk op-msg' data-timestamp='1445707380' id='432099'>
<a class='timestamp' href='#432099'><time timestamp='2015-10-24T17:23:00Z'>17:23</time></a>
&lt;<span class='nick nick-16'> wumpus</span>&gt;
(that&#x27;s where it is here, and I started about the same time)
<br>
</div>

<div class='talk op-msg' data-timestamp='1445707380' id='432100'>
<a class='timestamp' href='#432100'><time timestamp='2015-10-24T17:23:00Z'>17:23</time></a>
&lt;<span class='nick nick-8'> jcorgan</span>&gt;
no, 180k
<br>
</div>

<div class='talk op-msg' data-timestamp='1445707380' id='432101'>
<a class='timestamp' href='#432101'><time timestamp='2015-10-24T17:23:00Z'>17:23</time></a>
&lt;<span class='nick nick-16'> wumpus</span>&gt;
ok
<br>
</div>

<div class='talk op-msg' data-timestamp='1445707440' id='432102'>
<a class='timestamp' href='#432102'><time timestamp='2015-10-24T17:24:00Z'>17:24</time></a>
&lt;<span class='nick nick-16'> wumpus</span>&gt;
unbatched? hmm, doing a sqlite transaction per bitcoin transaction is certainly going to kill sqlite performance
<br>
</div>

<div class='talk op-msg' data-timestamp='1445707500' id='432103'>
<a class='timestamp' href='#432103'><time timestamp='2015-10-24T17:25:00Z'>17:25</time></a>
&lt;<span class='nick nick-8'> jcorgan</span>&gt;
restarted fresh with txindex=0, no difference in speed at the start, but we&#x27;ll see how it slows down
<br>
</div>

<div class='talk op-msg' data-timestamp='1445707500' id='432104'>
<a class='timestamp' href='#432104'><time timestamp='2015-10-24T17:25:00Z'>17:25</time></a>
&lt;<span class='nick nick-16'> wumpus</span>&gt;
there&#x27;s almost no transactions at the start :)
<br>
</div>

<div class='talk op-msg' data-timestamp='1445707500' id='432105'>
<a class='timestamp' href='#432105'><time timestamp='2015-10-24T17:25:00Z'>17:25</time></a>
&lt;<span class='nick nick-8'> jcorgan</span>&gt;
right :)
<br>
</div>

<div class='talk op-msg' data-timestamp='1445707560' id='432106'>
<a class='timestamp' href='#432106'><time timestamp='2015-10-24T17:26:00Z'>17:26</time></a>
&lt;<span class='nick nick-8'> jcorgan</span>&gt;
it&#x27;s about 200 blocks/sec 
<br>
</div>

<div class='talk op-msg' data-timestamp='1445707560' id='432107'>
<a class='timestamp' href='#432107'><time timestamp='2015-10-24T17:26:00Z'>17:26</time></a>
&lt;<span class='nick nick-9'> CodeShark</span>&gt;
I don&#x27;t even count the first 100k blocks :p
<br>
</div>

<div class='talk op-msg' data-timestamp='1445707800' id='432108'>
<a class='timestamp' href='#432108'><time timestamp='2015-10-24T17:30:00Z'>17:30</time></a>
&lt;<span class='nick nick-9'> CodeShark</span>&gt;
so are we benchmarking the SQLite stuff?
<br>
</div>

<div class='talk op-msg' data-timestamp='1445707800' id='432109'>
<a class='timestamp' href='#432109'><time timestamp='2015-10-24T17:30:00Z'>17:30</time></a>
&lt;<span class='nick nick-8'> jcorgan</span>&gt;
&quot;benchmarking&quot; would be generous
<br>
</div>

<div class='talk op-msg' data-timestamp='1445707860' id='432110'>
<a class='timestamp' href='#432110'><time timestamp='2015-10-24T17:31:00Z'>17:31</time></a>
&lt;<span class='nick nick-8'> jcorgan</span>&gt;
more like, wow, it actually works
<br>
</div>

<div class='talk op-msg' data-timestamp='1445707860' id='432111'>
<a class='timestamp' href='#432111'><time timestamp='2015-10-24T17:31:00Z'>17:31</time></a>
&lt;<span class='nick nick-16'> wumpus</span>&gt;
CodeShark: if you want: jgarzik repository, 2015_sqlite branch
<br>
</div>

<div class='talk op-msg' data-timestamp='1445707860' id='432112'>
<a class='timestamp' href='#432112'><time timestamp='2015-10-24T17:31:00Z'>17:31</time></a>
&lt;<span class='nick nick-9'> CodeShark</span>&gt;
jcorgan: why wouldn&#x27;t it work? :)
<br>
</div>

<div class='talk op-msg' data-timestamp='1445707920' id='432113'>
<a class='timestamp' href='#432113'><time timestamp='2015-10-24T17:32:00Z'>17:32</time></a>
&lt;<span class='nick nick-16'> wumpus</span>&gt;
it does actually work quite well :) although no one has tested yet if it is more resilient to crashes/poweroffs than leveldb, esp. on windows
<br>
</div>

<div class='talk op-msg' data-timestamp='1445707920' id='432114'>
<a class='timestamp' href='#432114'><time timestamp='2015-10-24T17:32:00Z'>17:32</time></a>
&lt;<span class='nick nick-8'> jcorgan</span>&gt;
um, with txindex=0, it just hit 120k in the last 10 minutes
<br>
</div>

<div class='talk op-msg' data-timestamp='1445707920' id='432115'>
<a class='timestamp' href='#432115'><time timestamp='2015-10-24T17:32:00Z'>17:32</time></a>
&lt;<span class='nick nick-9'> CodeShark</span>&gt;
sqlite is a pretty solid piece of software (albeit I&#x27;ve never tried using it for something that really taxes it)
<br>
</div>

<div class='talk op-msg' data-timestamp='1445707920' id='432116'>
<a class='timestamp' href='#432116'><time timestamp='2015-10-24T17:32:00Z'>17:32</time></a>
&lt;<span class='nick nick-13'> sipa</span>&gt;
jcorgan: that sounds very slow
<br>
</div>

<div class='talk op-msg' data-timestamp='1445707980' id='432117'>
<a class='timestamp' href='#432117'><time timestamp='2015-10-24T17:33:00Z'>17:33</time></a>
&lt;<span class='nick nick-16'> wumpus</span>&gt;
this is with autocheckpointing reenabled?
<br>
</div>

<div class='talk op-msg' data-timestamp='1445707980' id='432118'>
<a class='timestamp' href='#432118'><time timestamp='2015-10-24T17:33:00Z'>17:33</time></a>
&lt;<span class='nick nick-8'> jcorgan</span>&gt;
i don&#x27;t think so
<br>
</div>

<div class='talk op-msg' data-timestamp='1445708040' id='432119'>
<a class='timestamp' href='#432119'><time timestamp='2015-10-24T17:34:00Z'>17:34</time></a>
&lt;<span class='nick nick-16'> wumpus</span>&gt;
well it won&#x27;t get faster than that
<br>
</div>

<div class='talk op-msg' data-timestamp='1445708040' id='432120'>
<a class='timestamp' href='#432120'><time timestamp='2015-10-24T17:34:00Z'>17:34</time></a>
&lt;<span class='nick nick-8'> jcorgan</span>&gt;
wal, autocheckpoint=0
<br>
</div>

<div class='talk op-msg' data-timestamp='1445708100' id='432121'>
<a class='timestamp' href='#432121'><time timestamp='2015-10-24T17:35:00Z'>17:35</time></a>
&lt;<span class='nick nick-8'> jcorgan</span>&gt;
it just hit 180k
<br>
</div>

<div class='talk op-msg' data-timestamp='1445708100' id='432122'>
<a class='timestamp' href='#432122'><time timestamp='2015-10-24T17:35:00Z'>17:35</time></a>
&lt;<span class='nick nick-16'> wumpus</span>&gt;
doesn&#x27;t sound too bad to me
<br>
</div>

<div class='talk op-msg' data-timestamp='1445708100' id='432123'>
<a class='timestamp' href='#432123'><time timestamp='2015-10-24T17:35:00Z'>17:35</time></a>
&lt;<span class='nick nick-8'> jcorgan</span>&gt;
still at about 160 block/sec
<br>
</div>

<div class='talk op-msg' data-timestamp='1445708340' id='432124'>
<a class='timestamp' href='#432124'><time timestamp='2015-10-24T17:39:00Z'>17:39</time></a>
&lt;<span class='nick nick-5'> jgarzik</span>&gt;
Ideally you want a database system that ensures consistency, permits uninterrupted reads and writes, and optimizes in the background (i.e. &quot;optimize&quot; means move journalled data to final db position, updates indices, etc.)
<br>
</div>

<div class='talk op-msg' data-timestamp='1445708340' id='432125'>
<a class='timestamp' href='#432125'><time timestamp='2015-10-24T17:39:00Z'>17:39</time></a>
&lt;<span class='nick nick-5'> jgarzik</span>&gt;
app shouldn&#x27;t have to checkpoint
<br>
</div>

<div class='talk op-msg' data-timestamp='1445708400' id='432126'>
<a class='timestamp' href='#432126'><time timestamp='2015-10-24T17:40:00Z'>17:40</time></a>
&lt;<span class='nick nick-13'> sipa</span>&gt;
yes
<br>
</div>

<div class='talk op-msg' data-timestamp='1445708400' id='432127'>
<a class='timestamp' href='#432127'><time timestamp='2015-10-24T17:40:00Z'>17:40</time></a>
&lt;<span class='nick nick-8'> jcorgan</span>&gt;
wumpus: should i have made a further change in the pragmas?
<br>
</div>

<div class='talk op-msg' data-timestamp='1445708460' id='432128'>
<a class='timestamp' href='#432128'><time timestamp='2015-10-24T17:41:00Z'>17:41</time></a>
&lt;<span class='nick nick-8'> jcorgan</span>&gt;
also, what was that stop after import option, and can it be set in the .conf file?
<br>
</div>

<div class='talk op-msg' data-timestamp='1445708520' id='432129'>
<a class='timestamp' href='#432129'><time timestamp='2015-10-24T17:42:00Z'>17:42</time></a>
&lt;<span class='nick nick-5'> jgarzik</span>&gt;
reads locklessly read consistent data always, and writes do not stomp on that
<br>
</div>

<div class='talk op-msg' data-timestamp='1445708580' id='432130'>
<a class='timestamp' href='#432130'><time timestamp='2015-10-24T17:43:00Z'>17:43</time></a>
&lt;<span class='nick nick-16'> wumpus</span>&gt;
jgarzik: they do in sqlite, the checkpoint is just administrative, it doesn&#x27;t affect what readers read
<br>
</div>

<div class='talk op-msg' data-timestamp='1445708700' id='432131'>
<a class='timestamp' href='#432131'><time timestamp='2015-10-24T17:45:00Z'>17:45</time></a>
&lt;<span class='nick nick-16'> wumpus</span>&gt;
at the time checkpoint is called, new readers will already be reading the new state, by the time it can start ,old readers will be finished reading the old state, by definition
<br>
</div>

<div class='talk op-msg' data-timestamp='1445708820' id='432132'>
<a class='timestamp' href='#432132'><time timestamp='2015-10-24T17:47:00Z'>17:47</time></a>
&lt;<span class='nick nick-16'> wumpus</span>&gt;
jcorgan: well with autocheckpoint=0 it effectively appends all changes to the db-wal file instead of incorporating them
<br>
</div>

<div class='talk op-msg' data-timestamp='1445708820' id='432133'>
<a class='timestamp' href='#432133'><time timestamp='2015-10-24T17:47:00Z'>17:47</time></a>
&lt;<span class='nick nick-16'> wumpus</span>&gt;
this is a matter of where the data is stored, it doesn&#x27;t affect how clients perceive the database
<br>
</div>

<div class='talk op-msg' data-timestamp='1445708880' id='432134'>
<a class='timestamp' href='#432134'><time timestamp='2015-10-24T17:48:00Z'>17:48</time></a>
&lt;<span class='nick nick-13'> sipa</span>&gt;
but reading data from the wal file instead of the actual db must be slower?
<br>
</div>

<div class='talk op-msg' data-timestamp='1445708880' id='432135'>
<a class='timestamp' href='#432135'><time timestamp='2015-10-24T17:48:00Z'>17:48</time></a>
&lt;<span class='nick nick-5'> jgarzik</span>&gt;
there is impact if some operations are blocked by other operations
<br>
</div>

<div class='talk op-msg' data-timestamp='1445708880' id='432136'>
<a class='timestamp' href='#432136'><time timestamp='2015-10-24T17:48:00Z'>17:48</time></a>
&lt;<span class='nick nick-16'> wumpus</span>&gt;
could be
<br>
</div>

<div class='talk op-msg' data-timestamp='1445708940' id='432137'>
<a class='timestamp' href='#432137'><time timestamp='2015-10-24T17:49:00Z'>17:49</time></a>
&lt;<span class='nick nick-16'> wumpus</span>&gt;
there can certainly be performance impact, just not functionality/consistency impact, that&#x27;s all I&#x27;m saying...
<br>
</div>

<div class='talk op-msg' data-timestamp='1445708940' id='432138'>
<a class='timestamp' href='#432138'><time timestamp='2015-10-24T17:49:00Z'>17:49</time></a>
&lt;<span class='nick nick-5'> jgarzik</span>&gt;
nod
<br>
</div>

<div class='talk op-msg' data-timestamp='1445708940' id='432139'>
<a class='timestamp' href='#432139'><time timestamp='2015-10-24T17:49:00Z'>17:49</time></a>
&lt;<span class='nick nick-8'> jcorgan</span>&gt;
ok, restarted with txindex=0, wal, and removed the autocheckpoint=0
<br>
</div>

<div class='talk op-msg' data-timestamp='1445709000' id='432140'>
<a class='timestamp' href='#432140'><time timestamp='2015-10-24T17:50:00Z'>17:50</time></a>
&lt;<span class='nick nick-16'> wumpus</span>&gt;
db-wal  for chainstateshould stay at about 440M then
<br>
</div>

<div class='talk op-msg' data-timestamp='1445709000' id='432141'>
<a class='timestamp' href='#432141'><time timestamp='2015-10-24T17:50:00Z'>17:50</time></a>
&lt;<span class='nick nick-16'> wumpus</span>&gt;
(1-transaction-sized)
<br>
</div>

<div class='talk op-msg' data-timestamp='1445709060' id='432142'>
<a class='timestamp' href='#432142'><time timestamp='2015-10-24T17:51:00Z'>17:51</time></a>
&lt;<span class='nick nick-16'> wumpus</span>&gt;
hmm too big for one transaction.. no I don&#x27;t know :)
<br>
</div>

<div class='talk op-msg' data-timestamp='1445709180' id='432143'>
<a class='timestamp' href='#432143'><time timestamp='2015-10-24T17:53:00Z'>17:53</time></a>
&lt;<span class='nick nick-16'> wumpus</span>&gt;
at least it stays relatively constant around 440mb and doesn&#x27;t become GB&#x27;s big anymore, to really make it truncate one&#x27;d probably need the SQLITE_CHECKPOINT_TRUNCATE
<br>
</div>

<div class='talk op-msg' data-timestamp='1445709480' id='432144'>
<a class='timestamp' href='#432144'><time timestamp='2015-10-24T17:58:00Z'>17:58</time></a>
&lt;<span class='nick nick-5'> jgarzik</span>&gt;
jcorgan, current 2015_sqlite uses autocheckpoint=10000
<br>
</div>

<div class='talk op-msg' data-timestamp='1445709480' id='432145'>
<a class='timestamp' href='#432145'><time timestamp='2015-10-24T17:58:00Z'>17:58</time></a>
&lt;<span class='nick nick-5'> jgarzik</span>&gt;
not that I would suggest re-starting yet again :)
<br>
</div>

<div class='talk op-msg' data-timestamp='1445709540' id='432146'>
<a class='timestamp' href='#432146'><time timestamp='2015-10-24T17:59:00Z'>17:59</time></a>
&lt;<span class='nick nick-8'> jcorgan</span>&gt;
i have it scripted :)
<br>
</div>

<div class='talk op-msg' data-timestamp='1445710740' id='432147'>
<a class='timestamp' href='#432147'><time timestamp='2015-10-24T18:19:00Z'>18:19</time></a>
&lt;<span class='nick nick-8'> jcorgan</span>&gt;
hmm
<br>
</div>

<div class='talk op-msg' data-timestamp='1445710740' id='432148'>
<a class='timestamp' href='#432148'><time timestamp='2015-10-24T18:19:00Z'>18:19</time></a>
&lt;<span class='nick nick-8'> jcorgan</span>&gt;
-stopafterblock import shut it down at 183842
<br>
</div>

<div class='talk op-msg' data-timestamp='1445710860' id='432149'>
<a class='timestamp' href='#432149'><time timestamp='2015-10-24T18:21:00Z'>18:21</time></a>
&lt;<span class='nick nick-6'> btcdrak</span>&gt;
looks like i am missing the sqlite party
<br>
</div>

<div class='talk op-msg' data-timestamp='1445711340' id='432150'>
<a class='timestamp' href='#432150'><time timestamp='2015-10-24T18:29:00Z'>18:29</time></a>
&lt;<span class='nick nick-9'> CodeShark</span>&gt;
it gets really slow once it passes 230k
<br>
</div>

<div class='talk op-msg' data-timestamp='1445713140' id='432151'>
<a class='timestamp' href='#432151'><time timestamp='2015-10-24T18:59:00Z'>18:59</time></a>
&lt;<span class='nick nick-8'> jcorgan</span>&gt;
something strange is happening
<br>
</div>

<div class='talk op-msg' data-timestamp='1445713200' id='432152'>
<a class='timestamp' href='#432152'><time timestamp='2015-10-24T19:00:00Z'>19:00</time></a>
&lt;<span class='nick nick-8'> jcorgan</span>&gt;
the node stops reindexing at 183k, then starts up and asks connections for blocks at this point
<br>
</div>

<div class='talk op-msg' data-timestamp='1445713920' id='432153'>
<a class='timestamp' href='#432153'><time timestamp='2015-10-24T19:12:00Z'>19:12</time></a>
&lt;<span class='nick nick-8'> jcorgan</span>&gt;
ok, that&#x27;s weird
<br>
</div>

<div class='talk op-msg' data-timestamp='1445713920' id='432154'>
<a class='timestamp' href='#432154'><time timestamp='2015-10-24T19:12:00Z'>19:12</time></a>
&lt;<span class='nick nick-8'> jcorgan</span>&gt;
somehow i had restored a snapshot of bitcoin dir that only had 183k blocks in it
<br>
</div>

<div class='talk op-msg' data-timestamp='1445714040' id='432155'>
<a class='timestamp' href='#432155'><time timestamp='2015-10-24T19:14:00Z'>19:14</time></a>
&lt;<span class='nick nick-8'> jcorgan</span>&gt;
i cloned a new snapshot of the original and it is working fine with that
<br>
</div>

<div class='talk op-msg' data-timestamp='1445715960' id='432156'>
<a class='timestamp' href='#432156'><time timestamp='2015-10-24T19:46:00Z'>19:46</time></a>
&lt;<span class='nick nick-6'> btcdrak</span>&gt;
I rebased #6312 and #6564 (BIP68+CSV) into one branch for the people who asked to review both PRs in one changeset <a href="https://github.com/bitcoin/bitcoin/compare/master...btcdrak:sequenceandcsv" class="link" target="_blank">https://github.com/bitcoin/bitcoin/compare/master...btcdrak:sequenceandcsv</a>
<br>
</div>

</div>
</section>

</body>
</html>
